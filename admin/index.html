<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnFlux Admin Panel</title>
    <!-- Link to your main CSS file -->
    <link rel="stylesheet" href="style.css"> 
    <!-- Link to Google Fonts -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- Telegram Web App JS (if admin panel is also run within Telegram) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- TON Connect UI (if needed for admin wallet operations) -->
    <script src="https://unpkg.com/@tonconnect-ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
    <!-- Your admin panel layout. Make sure to include the container for the user list -->
    <div class="container"> 
        <div id="adminPanelContainer">
            <!-- Admin panel content will be loaded here -->
        </div>
    </div>

    <!-- Your Admin Script -->
    <script>
        // --- PASTE THE ADMIN JAVASCRIPT CODE PROVIDED ABOVE HERE ---
        // Make sure Firebase config and ADMIN_USER_IDS are correctly set.
        // Ensure currentUser is populated (e.g., by Telegram Web App if accessed via bot)

        // --- Core Setup for Admin Panel ---
        // This code block should be placed at the end of the admin.html file's body
        // or in a separate admin-specific JS file.

        // Replace with your actual Telegram User IDs that have admin privileges.
        const ADMIN_USER_IDS = [123456789, 987654321]; // <<-- REPLACE WITH YOUR ACTUAL TELEGRAM USER IDs

        // Ensure Firebase config and initialization are present BEFORE this script
        // Example:
        // const firebaseConfig = { ... };
        // try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
        // const database = firebase.database();

        // Assume currentUser is populated (e.g., from Telegram Web App if admin panel is within bot)
        // If not running within Telegram Web App, you'll need a way to authenticate the admin.
        
        let currentUser = null; // Placeholder, needs to be populated correctly if running in TWA

        // --- Ban/Unban Functions (Copied from above) ---
        function isAdmin() {
            if (!currentUser || !currentUser.id) return false;
            return ADMIN_USER_IDS.includes(currentUser.id);
        }

        async function checkUserBanStatus(userId) { /* ... implementation from above ... */ }
        function displayBanMessage() { /* ... implementation from above ... */ }
        async function enforceBan() { /* ... implementation from above ... */ return false; /* For admin, enforceBan is not directly relevant here unless admin actions are restricted */}

        async function banUser(userIdToBan, reason = "") {
            if (!isAdmin()) {
                showAlert("You are not authorized to perform this action.", "danger");
                return;
            }
            if (!userIdToBan) {
                console.error("Cannot ban: No user ID provided.");
                return;
            }
            
            const userRef = database.ref('users/' + userIdToBan);
            try {
                await userRef.update({ isBanned: true, banReason: reason });
                showAlert(`User ${userIdToBan} has been banned${reason ? ' with reason: ' + reason : ''}.`, 'success');
                console.log(`User ${userIdToBan} banned.`);
                // Refresh the user list to show the updated status
                loadUserListForAdmin(); 
            } catch (error) {
                console.error(`Error banning user ${userIdToBan}:`, error);
                showAlert(`Failed to ban user ${userIdToBan}. Please check console.`, 'danger');
            }
        }

        async function unbanUser(userIdToUnban) {
            if (!isAdmin()) {
                showAlert("You are not authorized to perform this action.", "danger");
                return;
            }
            if (!userIdToUnban) {
                console.error("Cannot unban: No user ID provided.");
                return;
            }
            
            const userRef = database.ref('users/' + userIdToUnban);
            try {
                await userRef.update({ isBanned: false, banReason: null }); 
                showAlert(`User ${userIdToUnban} has been unbanned.`, 'success');
                console.log(`User ${userIdToUnban} unbanned.`);
                loadUserListForAdmin(); // Refresh the user list
            } catch (error) {
                console.error(`Error unbanning user ${userIdToUnban}:`, error);
                showAlert(`Failed to unban user ${userIdToUnban}. Please check console.`, 'danger');
            }
        }


        // --- User List Loading and Rendering ---
        async function loadUserListForAdmin() {
            if (!isAdmin()) {
                showAlert("You are not authorized to view this page.", "danger");
                // Optionally redirect or show an error message
                return;
            }

            const userListContainer = document.getElementById('adminUserList');
            if (!userListContainer) {
                console.error("Admin user list container not found!");
                return;
            }

            userListContainer.innerHTML = '<div class="loading"></div> Loading users...';

            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                const users = snapshot.val();

                userListContainer.innerHTML = ''; // Clear loading indicator

                if (!users) {
                    userListContainer.innerHTML = '<p>No users found.</p>';
                    return;
                }

                const sortedUserIds = Object.keys(users).sort((a, b) => parseInt(a) - parseInt(b));

                sortedUserIds.forEach(userId => {
                    const userData = users[userId];
                    const isBanned = userData.isBanned === true;

                    const userRow = document.createElement('div');
                    userRow.style.display = 'flex';
                    userRow.style.justifyContent = 'space-between';
                    userRow.style.alignItems = 'center';
                    userRow.style.padding = '10px';
                    userRow.style.borderBottom = '1px solid var(--border-color)';
                    userRow.style.margin = '5px 0';
                    userRow.style.backgroundColor = isBanned ? 'rgba(220, 38, 38, 0.1)' : ''; // Highlight banned users

                    userRow.innerHTML = `
                        <div>
                            <strong>ID:</strong> ${userId} 
                            (${userData.first_name || 'No Name'})
                            ${isBanned ? '<span style="color: var(--danger); margin-left: 10px;">BANNED</span>' : ''}
                            ${userData.banReason ? `<span style="color: var(--warning); font-size: 0.8em; margin-left: 10px;">Reason: ${userData.banReason}</span>` : ''}
                        </div>
                        <div>
                            <input type="text" class="form-input" id="banReason_${userId}" placeholder="Ban Reason (optional)" style="width: 200px; margin-right: 10px;">
                            <button onclick="banUser(${userId}, document.getElementById('banReason_${userId}').value)" ${isBanned ? 'disabled' : ''} class="btn btn-danger" style="padding: 8px 15px;">Ban</button>
                            <button onclick="unbanUser(${userId})" ${!isBanned ? 'disabled' : ''} class="btn btn-success" style="padding: 8px 15px;">Unban</button>
                        </div>
                    `;
                    userListContainer.appendChild(userRow);
                });

            } catch (error) {
                console.error("Error loading user list for admin:", error);
                userListContainer.innerHTML = '<p style="color: var(--danger);">Failed to load users. Check console and Firebase rules.</p>';
            }
        }

        // --- Admin Panel Rendering ---
        function renderAdminPanel() {
            if (!isAdmin()) {
                // Show unauthorized message and possibly redirect
                const adminPanelContainer = document.getElementById('adminPanelContainer');
                if (adminPanelContainer) {
                    adminPanelContainer.innerHTML = `
                        <div class="card" style="text-align: center;">
                            <h2 class="card-title"><span class="material-icons">warning</span> Unauthorized Access</h2>
                            <p>You do not have administrator privileges to access this page.</p>
                        </div>
                    `;
                }
                return;
            }

            const adminPanelContainer = document.getElementById('adminPanelContainer');
            if (!adminPanelContainer) {
                console.error("Admin panel container not found!");
                return;
            }

            adminPanelContainer.innerHTML = `
                <div class="card">
                    <h2 class="card-title"><span class="material-icons">admin_panel_settings</span> Admin Dashboard</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Manage Users</label>
                        <div id="adminUserList">
                            <!-- User list will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Add other admin sections here if needed -->
                </div>
            `;

            loadUserListForAdmin();
        }

        // --- Initialization for Admin Panel ---
        // This part ensures that the admin panel loads correctly when the admin
        // page is accessed.
        document.addEventListener('DOMContentLoaded', () => {
            // IMPORTANT: You need to populate `currentUser` correctly for the admin panel.
            // If the admin panel is accessed via Telegram Web App, get user data from there.
            // If it's a separate web page, you'll need a login system or a way to
            // identify the admin (e.g., by hardcoding their Telegram ID and checking it).

            // For demonstration, we'll assume `currentUser` is already set or can be simulated.
            // If not running in Telegram context for admin:
            // currentUser = { id: 123456789, first_name: "Admin User", username: "admin", isBanned: false }; // Example admin user

            // If you are running this admin panel within your Telegram bot's mini-app,
            // you would call initTelegramWebApp() here as well.
            // initTelegramWebApp(); // Uncomment if admin panel runs in TWA

            // Call renderAdminPanel to show the dashboard
            renderAdminPanel(); 
        });

        // --- Helper functions (showAlert, formatNumber, etc.) ---
        // You'll need to ensure functions like showAlert, formatNumber, and
        // Firebase initialization are available in the scope of this script.
        // They can either be included here, or linked from a common JS file.

        // Placeholder for showAlert if not included from main script
        function showAlert(message, type) {
            console.log(`ALERT [${type}]: ${message}`); // Log to console for admin context
            // In a real admin UI, you'd have a more sophisticated alert/toast system.
            alert(message); // Simple browser alert
        }

        // Placeholder for formatNumber
        function formatNumber(num) { return String(num); } 

        // Placeholder for Firebase init and database object if not globally available
        // Ensure these are properly initialized before use.
        // const database = firebase.database(); 

    </script>
</body>
</html>
