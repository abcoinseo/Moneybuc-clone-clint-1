<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnFlux Admin Panel</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- TON Connect UI -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        /* --- Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3b82f6; --primary-dark: #2563eb; --primary-light: #60a5fa; --accent-blue: #0ea5e9;
            --background-dark: #0a0a0a; --surface-dark: #181818; --surface-dark-alt: #27272a; --border-color: #3f3f46;
            --text-primary: #ffffff; --text-secondary: #d4d4d8; --text-muted: #71717a;
            --success: #10b981; --danger: #dc2626; --warning: #f59e0b; --info: #0284c7;
            --glass-backdrop-filter: blur(25px); --glass-overlay-dark: rgba(24, 24, 27, 0.7); --glass-border: rgba(63, 63, 70, 0.5);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }
        /* --- Admin Specific Styles --- */
        .admin-container {
            max-width: 1400px; /* Wider container for admin */
            margin: 0 auto;
            padding: 30px 20px 100px;
        }
        .admin-header {
            background: var(--surface-dark);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .admin-header h1 {
            color: var(--primary);
            font-size: 2rem;
            font-weight: 700;
        }
        .admin-nav {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .admin-nav button {
            padding: 10px 18px;
            font-size: 0.95rem;
            border-radius: 12px;
        }
        .admin-view {
            margin-top: 25px;
        }
        .admin-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .admin-view-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--surface-dark);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        th, td {
            padding: 15px 18px;
            text-align: left;
            color: var(--text-secondary);
        }
        th {
            background: var(--surface-dark-alt);
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        tr:nth-child(even) {
            background: rgba(24, 24, 27, 0.5);
        }
        tr:hover {
            background: rgba(59, 130, 246, 0.1) !important;
        }
        td {
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        td.text-center { text-align: center; }
        .table-actions .btn { padding: 6px 10px; font-size: 0.8rem; }
        /* Modals */
        .modal {
            display: none; position: fixed; z-index: 2000; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px);
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content {
            background: var(--surface-dark); border: 1px solid var(--glass-border); border-radius: 24px;
            padding: 35px; max-width: 450px; width: 100%; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .close-btn {
            background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-muted);
            transition: all 0.3s ease;
        }
        .close-btn:hover { color: var(--text-secondary); transform: scale(1.1); }
        /* Specific forms */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); }
        .form-input, .form-select { width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; background: var(--surface-dark-alt); color: var(--text-primary); outline: none; }
        .form-input:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); }
        .form-select { appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 width%3D%2210%22 height%3D%225%22 viewBox%3D%220 0 10 5%22%3E%3Cpath d%3D%22M0 0l5 5 5-5%22 fill%3D%22%2394a6be%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: calc(100% - 18px) center; background-size: 10px; }
        .telegram-fields { display: none; }
        .telegram-fields.active { display: block; }
        /* Loading */
        .loading-container { text-align: center; padding: 30px; }
        .loading {
            display: inline-block; width: 24px; height: 24px; border: 4px solid rgba(255, 255, 255, .3);
            border-radius: 50%; border-top-color: var(--text-primary); animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Alerts */
        .alert {
            padding: 18px 25px; border-radius: 14px; margin-bottom: 25px; border-left: 5px solid;
            display: flex; align-items: center; gap: 15px; animation: slideIn 0.4s ease-out;
            position: relative; z-index: 1001; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .alert-success { background: rgba(16, 185, 121, 0.1); border-left-color: var(--success); color: var(--success); }
        .alert-danger { background: rgba(220, 38, 38, 0.1); border-left-color: var(--danger); color: var(--danger); }
        .alert-warning { background: rgba(217, 119, 6, 0.1); border-left-color: var(--warning); color: var(--warning); }
        .alert-info { background: rgba(2, 132, 199, 0.1); border-left-color: var(--info); color: var(--info); }

        @media (max-width: 768px) {
            .admin-header { flex-direction: column; text-align: center; }
            .admin-nav { flex-direction: column; align-items: center; width: 100%; }
            .admin-nav button { width: 100%; }
            th, td { padding: 10px 12px; font-size: 0.85rem; }
            th { font-size: 0.9rem; }
            .table-actions .btn { font-size: 0.75rem; }
            .admin-view-header { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>EarnFlux Admin Panel</h1>
            <div class="admin-nav">
                <button class="btn btn-primary" onclick="showAdminView('users')">Users</button>
                <button class="btn btn-info" onclick="showAdminView('tasks')">Tasks</button>
                <button class="btn btn-warning" onclick="showAdminView('luckyCodes')">Lucky Codes</button>
                <button class="btn btn-success" onclick="showAdminView('withdrawals')">Withdrawals</button>
                <button class="btn btn-accent" onclick="showAdminView('swapHistory')">Swap History</button>
                <button class="btn btn-secondary" onclick="window.location.href='index.html';">Back to App</button>
            </div>
        </div>

        <!-- User Management View -->
        <div id="adminUsersView" class="admin-view">
            <div class="admin-view-header">
                <h2><span class="material-icons">people</span> User Management</h2>
            </div>
            <div class="card">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Points</th>
                            <th>TON Balance</th>
                            <th>Tasks Done</th>
                            <th>Referrals</th>
                            <th>Created At</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- User data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Task Management View -->
        <div id="adminTasksView" class="admin-view" style="display: none;">
            <div class="admin-view-header">
                <h2><span class="material-icons">assignment</span> Task Management</h2>
                <button class="btn btn-primary" onclick="showTaskFormModal()">Add New Task</button>
            </div>
            <div class="card">
                <table id="tasksTable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Description</th>
                            <th>URL</th>
                            <th>Category</th>
                            <th>Reward</th>
                            <th>Impressions</th>
                            <th>Status</th>
                            <th>Created By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Task data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Lucky Code Management View -->
        <div id="adminLuckyCodesView" class="admin-view" style="display: none;">
            <div class="admin-view-header">
                <h2><span class="material-icons">card_giftcard</span> Lucky Code Management</h2>
                <button class="btn btn-primary" onclick="showLuckyCodeFormModal()">Add New Lucky Code</button>
            </div>
            <div class="card">
                <table id="luckyCodesTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Reward</th>
                            <th>Expires At</th>
                            <th>Used</th>
                            <th>Added By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Lucky code data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Withdrawal Management View -->
        <div id="adminWithdrawalsView" class="admin-view" style="display: none;">
            <div class="admin-view-header">
                <h2><span class="material-icons">account_balance_wallet</span> Withdrawal Management</h2>
            </div>
            <div class="card">
                <table id="withdrawalsTable">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>TON Address</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Processed At</th>
                            <th>Admin Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Withdrawal data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Swap History View -->
        <div id="adminSwapHistoryView" class="admin-view" style="display: none;">
            <div class="admin-view-header">
                <h2><span class="material-icons">swap_horiz</span> Swap History</h2>
            </div>
            <div class="card">
                <table id="swapHistoryTable">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Swap history data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Task Form Modal -->
    <div id="taskFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="taskModalTitle">Add New Task</h3>
                <button class="close-btn" onclick="closeModal('taskFormModal')">&times;</button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="task-title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="task-description" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" class="form-input" id="task-url" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="task-category" required>
                        <option value="normal">Normal</option>
                        <option value="telegram">Telegram</option>
                    </select>
                </div>
                <div class="form-group telegram-fields" id="task-telegram-fields">
                    <label class="form-label">Telegram Channel Username (@)</label>
                    <input type="text" class="form-input" id="task-telegram-channel" placeholder="channelname">
                </div>
                <div class="form-group">
                    <label class="form-label">Reward (Points)</label>
                    <input type="number" class="form-input" id="task-reward" required min="1">
                </div>
                 <div class="form-group">
                    <label class="form-label">Impressions</label>
                    <input type="number" class="form-input" id="task-impressions" required min="100" max="5000">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="task-status" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Save Task</button>
            </form>
        </div>
    </div>

    <!-- Lucky Code Form Modal -->
    <div id="luckyCodeFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="luckyCodeModalTitle">Add Lucky Code</h3>
                <button class="close-btn" onclick="closeModal('luckyCodeFormModal')">&times;</button>
            </div>
            <form id="luckyCodeForm">
                <input type="hidden" id="lucky-code-id">
                <div class="form-group">
                    <label class="form-label">Code</label>
                    <input type="text" class="form-input" id="lucky-code" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Reward (Points)</label>
                    <input type="number" class="form-input" id="lucky-code-reward" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Expires At</label>
                    <input type="datetime-local" class="form-input" id="lucky-code-expires-at" required>
                </div>
                <button type="submit" class="btn btn-primary">Save Lucky Code</button>
            </form>
        </div>
    </div>

    <!-- Withdrawal Action Modal -->
     <div id="withdrawalActionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Withdrawal Action</h3>
                <button class="close-btn" onclick="closeModal('withdrawalActionModal')">&times;</button>
            </div>
            <div id="withdrawalDetails">
                <!-- Withdrawal details will be loaded here -->
            </div>
            <form id="withdrawalActionForm">
                <input type="hidden" id="withdrawal-id-to-process">
                <div class="form-group">
                    <label class="form-label">Action</label>
                    <select class="form-select" id="withdrawal-status-input" required>
                        <option value="">Select Action</option>
                        <option value="completed">Mark as Completed</option>
                        <option value="rejected">Mark as Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Admin Notes (Optional)</label>
                    <textarea class="form-input" id="withdrawal-notes-input" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Submit Action</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <!-- Your custom admin JS (assuming it's in js/admin.js) -->
    <!-- If you keep JS inline, make sure to uncomment and place it here -->

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3SqCHzN3kLj7DC8Cyu9OzxPFtIlyyii4",
            authDomain: "maneybux-clone.firebaseapp.com",
            databaseURL: "https://maneybux-clone-default-rtdb.firebaseio.com",
            projectId: "maneybux-clone",
            storageBucket: "maneybux-clone.firebasestorage.app",
            messagingSenderId: "153207109623",
            appId: "1:153207109623:web:4cd48633c49c2ba3c1a0f2"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            firebase.app();
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Firebase initialization failed. Please check your Firebase configuration and network connection.");
        }
        const database = firebase.database();
        const functions = firebase.functions();

        // --- TON Connect UI ---
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://your-domain.com/tonconnect-manifest.json', // Replace with YOUR manifest URL
            actionsConfiguration: {
                twaReturnUrl: 'https://t.me/YOUR_BOT_USERNAME' // Your bot's username
            }
        });

        // --- Global Variables ---
        let currentFirebaseUser = null;
        const ADMIN_ROLE = 'admin';

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            // *** IMPORTANT: Implement Proper Firebase Authentication Here ***
            // This is a placeholder. You MUST integrate Firebase Authentication.
            console.warn("Admin Authentication is NOT fully implemented. Please implement Firebase Authentication and role checks.");

            // Simulate a logged-in admin user for testing purposes.
            // Replace 'simulated-admin-uid-12345' with a UID from your Firebase Auth
            // that has 'admin' role in the 'users' node.
            const simulatedAdminUid = 'simulated-admin-uid-12345';
            currentFirebaseUser = { uid: simulatedAdminUid };

            await checkAdminRole();
            loadAdminData();
        });

        async function checkAdminRole() {
            if (!currentFirebaseUser) {
                handleNoAdminAccess();
                return false;
            }
            try {
                const userRef = database.ref(`users/${currentFirebaseUser.uid}`);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                if (userData && userData.role === ADMIN_ROLE) {
                    console.log(`User ${currentFirebaseUser.uid} authenticated as admin.`);
                    return true;
                } else {
                    console.log(`User ${currentFirebaseUser.uid} is not an admin.`);
                    handleNoAdminAccess();
                    return false;
                }
            } catch (error) {
                console.error("Error checking admin role:", error);
                handleNoAdminAccess();
                return false;
            }
        }

        function handleNoAdminAccess() {
            alert("Access Denied: You are not authorized to view the admin panel. Please log in as an administrator.");
            window.location.href = 'index.html';
        }

        function loadAdminData() {
            loadUsersTable();
            loadTasksTable();
            loadLuckyCodesTable();
            loadWithdrawalsTable();
            loadSwapHistoryTable();
        }

        function showAdminView(viewName) {
            document.querySelectorAll('.admin-view').forEach(view => { view.style.display = 'none'; });
            document.getElementById(`admin${viewName.charAt(0).toUpperCase() + viewName.slice(1)}View`).style.display = 'block';
        }

        // --- Utility Functions ---
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }
        function showAlert(message, type) {
            const container = document.querySelector('.admin-container');
            if (!container) { alert(message); return; }
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<span class="material-icons">${type === 'success' ? 'check_circle' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'error'}</span>${message}`;
            container.prepend(alert);
            setTimeout(() => { if (alert && alert.parentNode) alert.remove(); }, 5000);
        }
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            num = Number(num);
            if (num >= 1e12) return (num / 1e12).toFixed(1).replace(/\.0$/, '') + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(1).replace(/\.0$/, '') + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1).replace(/\.0$/, '') + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1).replace(/\.0$/, '') + 'K';
            return num.toString();
        }
        function getFormattedDate(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleString();
        }

        // --- Task Management ---
        function showTaskFormModal(task = null) {
            const modal = document.getElementById('taskFormModal');
            const modalTitle = document.getElementById('taskModalTitle');
            const form = document.getElementById('taskForm');
            const taskIdInput = document.getElementById('task-id');
            const titleInput = document.getElementById('task-title');
            const descriptionInput = document.getElementById('task-description');
            const urlInput = document.getElementById('task-url');
            const categoryInput = document.getElementById('task-category');
            const telegramChannelInput = document.getElementById('task-telegram-channel');
            const rewardInput = document.getElementById('task-reward');
            const impressionsInput = document.getElementById('task-impressions');
            const statusInput = document.getElementById('task-status');
            const telegramFieldsDiv = document.getElementById('task-telegram-fields');

            form.reset();
            taskIdInput.value = '';
            modalTitle.textContent = 'Add New Task';

            if (task) {
                modalTitle.textContent = 'Edit Task';
                taskIdInput.value = task.id;
                titleInput.value = task.title;
                descriptionInput.value = task.description;
                urlInput.value = task.url;
                categoryInput.value = task.category || 'normal';
                rewardInput.value = task.reward || 100;
                impressionsInput.value = task.impressions || 1000;
                statusInput.value = task.status || 'active';
                if (task.category === 'telegram') {
                    telegramChannelInput.value = task.telegramChannel || '';
                    telegramFieldsDiv.classList.add('active');
                } else {
                    telegramFieldsDiv.classList.remove('active');
                }
            } else {
                categoryInput.value = 'normal';
                rewardInput.value = 100;
                impressionsInput.value = 1000;
                statusInput.value = 'active';
                telegramFieldsDiv.classList.remove('active');
            }

            categoryInput.onchange = () => {
                if (categoryInput.value === 'telegram') {
                    telegramFieldsDiv.classList.add('active');
                    telegramChannelInput.setAttribute('required', 'true');
                } else {
                    telegramFieldsDiv.classList.remove('active');
                    telegramChannelInput.removeAttribute('required');
                }
            };
            categoryInput.onchange();
            modal.style.display = 'flex';
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            try {
                const callable = functions.httpsCallable('adminDeleteTask');
                await callable({ taskId });
                showAlert('Task deleted successfully!', 'success');
                loadTasksTable();
            } catch (error) {
                console.error("Error deleting task:", error);
                showAlert(`Failed to delete task: ${error.message}`, 'danger');
            }
        }

        async function saveTask() {
            const modal = document.getElementById('taskFormModal');
            const taskId = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const url = document.getElementById('task-url').value.trim();
            const category = document.getElementById('task-category').value;
            const telegramChannel = document.getElementById('task-telegram-channel').value.trim();
            const reward = parseInt(document.getElementById('task-reward').value);
            const impressions = parseInt(document.getElementById('task-impressions').value);
            const status = document.getElementById('task-status').value;

            if (!title || !description || !url || isNaN(reward) || reward < 1 || isNaN(impressions) || impressions < 100 || (category === 'telegram' && !telegramChannel)) {
                showAlert('Please fill in all fields with valid data.', 'danger');
                return;
            }

            const submitButton = modal.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading"></div> Saving...';

            try {
                let callable;
                const data = { taskId: taskId || null, title, description, url, category, telegramChannel, reward, impressions, status };

                if (taskId) {
                    callable = functions.httpsCallable('adminEditTask');
                } else {
                    callable = functions.httpsCallable('adminAddTask');
                }

                const result = await callable(data);

                if (result.data.success) {
                    showAlert(taskId ? 'Task updated successfully!' : 'Task added successfully!', 'success');
                    closeModal('taskFormModal');
                    loadTasksTable();
                } else {
                    showAlert('Failed to save task. Please try again.', 'danger');
                }
            } catch (error) {
                console.error("Error saving task:", error);
                showAlert(`Failed to save task: ${error.message}`, 'danger');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Save Task';
            }
        }

        // --- Lucky Code Management ---
        function showLuckyCodeFormModal(code = null) {
            const modal = document.getElementById('luckyCodeFormModal');
            const modalTitle = document.getElementById('luckyCodeModalTitle');
            const form = document.getElementById('luckyCodeForm');
            const codeIdInput = document.getElementById('lucky-code-id');
            const codeInput = document.getElementById('lucky-code');
            const rewardInput = document.getElementById('lucky-code-reward');
            const expiresAtInput = document.getElementById('lucky-code-expires-at');

            form.reset();
            codeIdInput.value = '';
            modalTitle.textContent = 'Add Lucky Code';

            if (code) {
                modalTitle.textContent = 'Edit Lucky Code';
                codeIdInput.value = code.id;
                codeInput.value = code.code;
                rewardInput.value = code.reward;
                const expiresDate = new Date(code.expiresAt);
                expiresAtInput.value = expiresDate.toISOString().slice(0, 16);
            } else {
                const defaultExpires = new Date(Date.now() + 24 * 60 * 60 * 1000);
                expiresAtInput.value = defaultExpires.toISOString().slice(0, 16);
            }
            modal.style.display = 'flex';
        }

        async function deleteLuckyCode(codeId) {
            if (!confirm('Are you sure you want to delete this lucky code?')) return;
            try {
                const callable = functions.httpsCallable('adminDeleteLuckyCode');
                await callable({ codeId });
                showAlert('Lucky code deleted successfully!', 'success');
                loadLuckyCodesTable();
            } catch (error) {
                console.error("Error deleting lucky code:", error);
                showAlert(`Failed to delete lucky code: ${error.message}`, 'danger');
            }
        }

        async function saveLuckyCode() {
            const modal = document.getElementById('luckyCodeFormModal');
            const codeId = document.getElementById('lucky-code-id').value;
            const code = document.getElementById('lucky-code').value.trim().toUpperCase();
            const reward = parseInt(document.getElementById('lucky-code-reward').value);
            const expiresAtLocal = document.getElementById('lucky-code-expires-at').value;
            const expiresAt = new Date(expiresAtLocal).getTime();

            if (!code || isNaN(reward) || reward < 1 || !expiresAt) {
                showAlert('Please fill in all fields with valid data.', 'danger');
                return;
            }

            const submitButton = modal.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading"></div> Saving...';

            try {
                const callable = functions.httpsCallable('adminAddLuckyCode');
                const result = await callable({ codeId: codeId || null, code, reward, expiresAt });

                if (result.data.success) {
                    showAlert(codeId ? 'Lucky code updated successfully!' : 'Lucky code added successfully!', 'success');
                    closeModal('luckyCodeFormModal');
                    loadLuckyCodesTable();
                } else {
                    showAlert('Failed to save lucky code. Please try again.', 'danger');
                }
            } catch (error) {
                console.error("Error saving lucky code:", error);
                showAlert(`Failed to save lucky code: ${error.message}`, 'danger');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Save Lucky Code';
            }
        }

        // --- Withdrawal Management ---
        function openWithdrawalActionModal(withdrawalId, userId, tonAddress, amountTon) {
            const modal = document.getElementById('withdrawalActionModal');
            const detailsDiv = document.getElementById('withdrawalDetails');
            const idInput = document.getElementById('withdrawal-id-to-process');
            const statusInput = document.getElementById('withdrawal-status-input');
            const notesInput = document.getElementById('withdrawal-notes-input');

            detailsDiv.innerHTML = `
                <p><strong>User ID:</strong> ${userId}</p>
                <p><strong>TON Address:</strong> ${tonAddress}</p>
                <p><strong>Amount:</strong> ${amountTon.toFixed(8)} TON</p>
            `;
            idInput.value = withdrawalId;
            statusInput.value = '';
            notesInput.value = '';
            modal.style.display = 'flex';
        }

        async function rejectWithdrawal(withdrawalId) {
            if (!confirm('Are you sure you want to reject this withdrawal?')) return;
            try {
                const callable = functions.httpsCallable('adminUpdateWithdrawalStatus');
                await callable({ withdrawalId, status: 'rejected', adminNotes: 'Rejected by admin' });
                showAlert('Withdrawal rejected successfully!', 'success');
                loadWithdrawalsTable();
            } catch (error) {
                console.error("Error rejecting withdrawal:", error);
                showAlert(`Failed to reject withdrawal: ${error.message}`, 'danger');
            }
        }

        async function processWithdrawal() {
            const modal = document.getElementById('withdrawalActionModal');
            const withdrawalId = document.getElementById('withdrawal-id-to-process').value;
            const status = document.getElementById('withdrawal-status-input').value;
            const adminNotes = document.getElementById('withdrawal-notes-input').value.trim();

            if (!status || !withdrawalId) {
                showAlert('Please select an action.', 'danger');
                return;
            }

            const submitButton = modal.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading"></div> Processing...';

            try {
                const callable = functions.httpsCallable('adminUpdateWithdrawalStatus');
                await callable({ withdrawalId, status, adminNotes });
                
                showAlert(`Withdrawal marked as ${status} successfully!`, 'success');
                closeModal('withdrawalActionModal');
                loadWithdrawalsTable();
            } catch (error) {
                console.error("Error processing withdrawal:", error);
                showAlert(`Failed to process withdrawal: ${error.message}`, 'danger');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Submit Action';
            }
        }

        // --- Table Loading Functions ---
        function loadUsersTable() {
            const tableBody = document.querySelector('#usersTable tbody');
            tableBody.innerHTML = `<tr><td colspan="10" class="text-center"><div class="loading"></div> Loading users...</td></tr>`;
            
            const callable = functions.httpsCallable('adminGetAllUsers');
            callable()
                .then(result => {
                    const users = result.data.users || {};
                    tableBody.innerHTML = '';
                    Object.keys(users).forEach(userId => {
                        const user = users[userId];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${userId}</td>
                            <td>${user.first_name || 'N/A'}</td>
                            <td>${user.username || 'N/A'}</td>
                            <td>${formatNumber(user.balance || 0)}</td>
                            <td>${(user.tonBalance || 0).toFixed(8)}</td>
                            <td>${user.tasksCompleted || 0}</td>
                            <td>${user.referrals || 0}</td>
                            <td>${getFormattedDate(user.createdAt)}</td>
                            <td>${user.role || 'user'}</td>
                            <td class="table-actions">
                                <button class="btn btn-secondary" onclick='editUser("${userId}", "${user.role || 'user'}")'><span class="material-icons">edit</span></button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    if (Object.keys(users).length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No users found.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error("Error loading users:", error);
                    tableBody.innerHTML = `<tr><td colspan="10" class="text-center" style="color: var(--danger);">Failed to load users: ${error.message}</td></tr>`;
                    showAlert(`Failed to load users: ${error.message}`, 'danger');
                });
        }

        function loadTasksTable() {
            const tableBody = document.querySelector('#tasksTable tbody');
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center"><div class="loading"></div> Loading tasks...</td></tr>`;
            
            database.ref('tasks').once('value', (snapshot) => {
                const tasks = snapshot.val() || {};
                tableBody.innerHTML = '';
                Object.keys(tasks).forEach(taskId => {
                    const task = tasks[taskId];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${task.title}</td>
                        <td>${task.description.substring(0, 50)}...</td>
                        <td><a href="${task.url}" target="_blank" style="color: var(--primary);">${task.url.substring(0, 30)}...</a></td>
                        <td>${task.category || 'normal'}</td>
                        <td>${task.reward || 100} pts</td>
                        <td>${task.impressions || 0}</td>
                        <td><span class="history-status status-${task.status}">${task.status}</span></td>
                        <td>${task.createdBy || 'System'}</td>
                        <td class="table-actions">
                            <button class="btn btn-secondary" onclick='showTaskFormModal(${JSON.stringify({ id: taskId, ...task })})'><span class="material-icons">edit</span></button>
                            <button class="btn btn-danger" onclick="deleteTask('${taskId}')"><span class="material-icons">delete</span></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                if (Object.keys(tasks).length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="9" class="text-center">No tasks found.</td></tr>';
                }
            }, (error) => {
                console.error("Error loading tasks:", error);
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center" style="color: var(--danger);">Failed to load tasks: ${error.message}</td></tr>`;
                showAlert(`Failed to load tasks: ${error.message}`, 'danger');
            });
        }

        function loadLuckyCodesTable() {
            const tableBody = document.querySelector('#luckyCodesTable tbody');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center"><div class="loading"></div> Loading lucky codes...</td></tr>`;
            
            database.ref('luckyCodes').once('value', (snapshot) => {
                const codes = snapshot.val() || {};
                tableBody.innerHTML = '';
                Object.keys(codes).forEach(codeId => {
                    const code = codes[codeId];
                    const expiresDate = new Date(code.expiresAt);
                    const isExpired = code.expiresAt < Date.now();
                    const statusClass = isExpired ? 'status-expired' : (code.used ? 'status-used' : 'status-active');
                    const statusText = isExpired ? 'Expired' : (code.used ? 'Used' : 'Active');

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${code.code}</td>
                        <td>${code.reward || 0} pts</td>
                        <td>${getFormattedDate(code.expiresAt)}</td>
                        <td><span class="history-status ${statusClass}">${statusText}</span></td>
                        <td>${code.addedBy || 'N/A'}</td>
                        <td class="table-actions">
                            <button class="btn btn-secondary" onclick='showLuckyCodeFormModal(${JSON.stringify({ id: codeId, ...code })})'><span class="material-icons">edit</span></button>
                            <button class="btn btn-danger" onclick="deleteLuckyCode('${codeId}')"><span class="material-icons">delete</span></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                if (Object.keys(codes).length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No lucky codes found.</td></tr>';
                }
            }, (error) => {
                console.error("Error loading lucky codes:", error);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center" style="color: var(--danger);">Failed to load lucky codes: ${error.message}</td></tr>`;
                showAlert(`Failed to load lucky codes: ${error.message}`, 'danger');
            });
        }

        function loadWithdrawalsTable() {
            const tableBody = document.querySelector('#withdrawalsTable tbody');
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center"><div class="loading"></div> Loading withdrawals...</td></tr>`;

            const callable = functions.httpsCallable('adminGetWithdrawals');
            callable()
                .then(result => {
                    const withdrawals = result.data.withdrawals || {};
                    tableBody.innerHTML = '';
                    const sortedWithdrawals = Object.entries(withdrawals).sort(([, a], [, b]) => b.createdAt - a.createdAt);

                    sortedWithdrawals.forEach(([withdrawalId, withdrawal]) => {
                        const row = document.createElement('tr');
                        const statusClass = `status-${withdrawal.status}`;
                        const statusText = withdrawal.status.charAt(0).toUpperCase() + withdrawal.status.slice(1);

                        row.innerHTML = `
                            <td>${withdrawal.userId || 'N/A'}</td>
                            <td>${withdrawal.tonAddress ? withdrawal.tonAddress.substring(0, 8) + '...' + withdrawal.tonAddress.substring(withdrawal.tonAddress.length - 8) : 'N/A'}</td>
                            <td>${withdrawal.amountTon ? withdrawal.amountTon.toFixed(8) + ' TON' : 'N/A'}</td>
                            <td><span class="history-status ${statusClass}">${statusText}</span></td>
                            <td>${getFormattedDate(withdrawal.createdAt)}</td>
                            <td>${getFormattedDate(withdrawal.processedAt)}</td>
                            <td>${withdrawal.adminNotes || ''}</td>
                            <td class="table-actions">
                                ${withdrawal.status === 'pending' ? `
                                    <button class="btn btn-success" onclick="openWithdrawalActionModal('${withdrawalId}', '${withdrawal.userId}', '${withdrawal.tonAddress}', ${withdrawal.amountTon})"><span class="material-icons">check</span></button>
                                    <button class="btn btn-danger" onclick="rejectWithdrawal('${withdrawalId}')"><span class="material-icons">close</span></button>
                                ` : `
                                    <button class="btn btn-secondary" disabled><span class="material-icons">done_all</span></button>
                                `}
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    if (sortedWithdrawals.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No withdrawal requests found.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error("Error loading withdrawals:", error);
                    tableBody.innerHTML = `<tr><td colspan="8" class="text-center" style="color: var(--danger);">Failed to load withdrawals: ${error.message}</td></tr>`;
                    showAlert(`Failed to load withdrawals: ${error.message}`, 'danger');
                });
        }

        function loadSwapHistoryTable() {
            const tableBody = document.querySelector('#swapHistoryTable tbody');
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center"><div class="loading"></div> Loading swap history...</td></tr>`;
            
            database.ref('swapHistory').once('value', (snapshot) => {
                const swaps = snapshot.val() || {};
                tableBody.innerHTML = '';
                const sortedSwaps = Object.entries(swaps).sort(([, a], [, b]) => b.timestamp - a.timestamp);

                sortedSwaps.forEach(([swapId, swap]) => {
                    const row = document.createElement('tr');
                    let details = '';
                    if (swap.type === 'pointsToTon') {
                        details = `${formatNumber(swap.pointsAmount)} Points → ${swap.tonAmount.toFixed(8)} TON`;
                    } else {
                        details = `${swap.tonAmount.toFixed(8)} TON → ${formatNumber(swap.pointsAmount)} Points`;
                    }
                    row.innerHTML = `
                        <td>${swap.userId || 'N/A'}</td>
                        <td>${swap.type}</td>
                        <td>${details}</td>
                        <td>${getFormattedDate(swap.timestamp)}</td>
                    `;
                    tableBody.appendChild(row);
                });
                if (sortedSwaps.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No swap history found.</td></tr>';
                }
            }, (error) => {
                console.error("Error loading swap history:", error);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center" style="color: var(--danger);">Failed to load swap history: ${error.message}</td></tr>`;
                showAlert(`Failed to load swap history: ${error.message}`, 'danger');
            });
        }

        // --- Event Listeners for Modals ---
        document.getElementById('taskForm').addEventListener('submit', (e) => { e.preventDefault(); saveTask(); });
        document.getElementById('luckyCodeForm').addEventListener('submit', (e) => { e.preventDefault(); saveLuckyCode(); });
        document.getElementById('withdrawalActionForm').addEventListener('submit', (e) => { e.preventDefault(); processWithdrawal(); });

        // --- Helper Functions for Modals ---
        async function editUser(userId, role) {
            showAlert(`Editing role for user ${userId} (current: ${role}). Implement role update functionality.`, 'info');
        }

        async function rejectWithdrawal(withdrawalId) {
            if (!confirm('Are you sure you want to reject this withdrawal?')) return;
            try {
                const callable = functions.httpsCallable('adminUpdateWithdrawalStatus');
                await callable({ withdrawalId, status: 'rejected', adminNotes: 'Rejected by admin' });
                showAlert('Withdrawal rejected successfully!', 'success');
                loadWithdrawalsTable();
            } catch (error) {
                console.error("Error rejecting withdrawal:", error);
                showAlert(`Failed to reject withdrawal: ${error.message}`, 'danger');
            }
        }

        // --- Initial View Setup ---
        window.onload = () => {
            showAdminView('users');
        };
    </script>
</body>
</html>
