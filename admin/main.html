<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnFlux Admin Panel</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            /* Professional Dark & Blue Theme Colors */
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --accent-blue: #0ea5e9;
            
            --background-dark: #0a0a0a;
            --surface-dark: #18181b;
            --surface-dark-alt: #27272a;
            --border-color: #3f3f46;
            
            --text-primary: #ffffff;
            --text-secondary: #d4d4d8;
            --text-muted: #71717a;
            
            --success: #10b981;
            --danger: #dc2626;
            --warning: #f59e0b;
            --info: #0284c7;
            
            --glass-backdrop-filter: blur(25px);
            --glass-overlay-dark: rgba(24, 24, 27, 0.7);
            --glass-border: rgba(63, 63, 70, 0.5);
        }

        body {
            font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(96, 165, 250, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--glass-overlay-dark);
            backdrop-filter: var(--glass-backdrop-filter);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--primary);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1rem;
        }

        .card {
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }

        .tabs {
            display: flex;
            background: var(--surface-dark-alt);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-muted);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--surface-dark-alt);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #047857);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 121, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #b45309);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }

        .btn-secondary {
            background: var(--surface-dark-alt);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--surface-dark-alt);
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active { background: rgba(16, 185, 121, 0.2); color: var(--success); }
        .status-inactive { background: rgba(113, 113, 122, 0.2); color: var(--text-muted); }
        .status-pending { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-completed { background: rgba(16, 185, 121, 0.2); color: var(--success); }
        .status-rejected { background: rgba(220, 38, 38, 0.2); color: var(--danger); }
        .status-banned { background: rgba(220, 38, 38, 0.2); color: var(--danger); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: var(--danger);
            transform: scale(1.1);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success { background: rgba(16, 185, 121, 0.1); border-left-color: var(--success); color: var(--success); }
        .alert-danger { background: rgba(220, 38, 38, 0.1); border-left-color: var(--danger); color: var(--danger); }
        .alert-warning { background: rgba(245, 158, 11, 0.1); border-left-color: var(--warning); color: var(--warning); }
        .alert-info { background: rgba(2, 132, 199, 0.1); border-left-color: var(--info); color: var(--info); }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--surface-dark-alt);
            color: var(--text-primary);
            outline: none;
        }

        .search-input:focus {
            border-color: var(--primary);
        }

        .ip-duplicate {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
        }

        .message-preview {
            background: var(--surface-dark-alt);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: var(--text-secondary);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }

        .refresh-indicator {
            display: inline-block;
            animation: rotate 1s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="material-icons">admin_panel_settings</span>
                EarnFlux Admin Panel
            </h1>
            <button class="btn btn-primary" onclick="refreshData()">
                <span class="material-icons" id="refreshIcon">refresh</span>
                Refresh Data
            </button>
        </div>

        <!-- Dashboard Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalTasks">0</div>
                <div class="stat-label">Active Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalWithdrawals">0</div>
                <div class="stat-label">Pending Withdrawals</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEarnings">0</div>
                <div class="stat-label">Total Platform Earnings</div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="showTab('dashboard')">Dashboard</div>
                <div class="tab" onclick="showTab('tasks')">Tasks</div>
                <div class="tab" onclick="showTab('users')">Users</div>
                <div class="tab" onclick="showTab('withdrawals')">Withdrawals</div>
                <div class="tab" onclick="showTab('luckyCodes')">Lucky Codes</div>
                <div class="tab" onclick="showTab('messaging')">Messaging</div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <h2 class="card-title">
                    <span class="material-icons">dashboard</span>
                    System Overview
                </h2>
                
                <div class="grid-2">
                    <div class="card">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Recent Activities</h3>
                        <div id="recentActivities">Loading...</div>
                    </div>
                    
                    <div class="card">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">System Health</h3>
                        <div id="systemHealth">
                            <div style="margin-bottom: 10px;">Database: <span style="color: var(--success);">Connected</span></div>
                            <div style="margin-bottom: 10px;">Telegram Bot: <span id="botStatus">Checking...</span></div>
                            <div>Last Updated: <span id="lastUpdated">-</span></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">IP Analysis</h3>
                    <div id="ipAnalysis">Loading...</div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasksTab" class="tab-content">
                <h2 class="card-title">
                    <span class="material-icons">assignment</span>
                    Task Management
                </h2>
                
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showModal('addTaskModal')">
                        <span class="material-icons">add</span>
                        Add New Task
                    </button>
                    <button class="btn btn-warning" onclick="loadTasks()">
                        <span class="material-icons">refresh</span>
                        Refresh Tasks
                    </button>
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" id="taskSearch" placeholder="Search tasks..." oninput="filterTasks()">
                    <select class="form-select" id="taskStatusFilter" onchange="filterTasks()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>

                <div id="tasksContainer">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Task ID</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Reward</th>
                                <th>Impressions</th>
                                <th>Created By</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <tr><td colspan="8" style="text-align: center;">Loading tasks...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <h2 class="card-title">
                    <span class="material-icons">people</span>
                    User Management
                </h2>

                <div class="search-container">
                    <input type="text" class="search-input" id="userSearch" placeholder="Search users..." oninput="filterUsers()">
                    <select class="form-select" id="userStatusFilter" onchange="filterUsers()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="banned">Banned</option>
                    </select>
                    <button class="btn btn-warning" onclick="loadUsers()">
                        <span class="material-icons">refresh</span>
                        Refresh Users
                    </button>
                </div>

                <div id="usersContainer">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Balance</th>
                                <th>TON Balance</th>
                                <th>IP Address</th>
                                <th>Joined</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="9" style="text-align: center;">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Withdrawals Tab -->
            <div id="withdrawalsTab" class="tab-content">
                <h2 class="card-title">
                    <span class="material-icons">account_balance_wallet</span>
                    Withdrawal Management
                </h2>

                <div class="search-container">
                    <input type="text" class="search-input" id="withdrawalSearch" placeholder="Search withdrawals..." oninput="filterWithdrawals()">
                    <select class="form-select" id="withdrawalStatusFilter" onchange="filterWithdrawals()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <button class="btn btn-warning" onclick="loadWithdrawals()">
                        <span class="material-icons">refresh</span>
                        Refresh
                    </button>
                </div>

                <div id="withdrawalsContainer">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Amount (TON)</th>
                                <th>Address</th>
                                <th>Requested</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTableBody">
                            <tr><td colspan="7" style="text-align: center;">Loading withdrawals...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Lucky Codes Tab -->
            <div id="luckyCodesTab" class="tab-content">
                <h2 class="card-title">
                    <span class="material-icons">redeem</span>
                    Lucky Code Management
                </h2>

                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showModal('addLuckyCodeModal')">
                        <span class="material-icons">add</span>
                        Create Lucky Code
                    </button>
                    <button class="btn btn-warning" onclick="loadLuckyCodes()">
                        <span class="material-icons">refresh</span>
                        Refresh
                    </button>
                </div>

                <div id="luckyCodesContainer">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Reward</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Used</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="luckyCodesTableBody">
                            <tr><td colspan="6" style="text-align: center;">Loading lucky codes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Messaging Tab -->
            <div id="messagingTab" class="tab-content">
                <h2 class="card-title">
                    <span class="material-icons">message</span>
                    User Messaging
                </h2>

                <div class="grid-2">
                    <div class="card">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Send Message to User</h3>
                        <form id="singleMessageForm">
                            <div class="form-group">
                                <label class="form-label">User ID</label>
                                <input type="text" class="form-input" id="messageUserId" placeholder="Enter User ID" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Message</label>
                                <textarea class="form-textarea" id="messageContent" placeholder="Enter your message..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <span class="material-icons">send</span>
                                Send Message
                            </button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Broadcast Message</h3>
                        <form id="broadcastMessageForm">
                            <div class="form-group">
                                <label class="form-label">Target Audience</label>
                                <select class="form-select" id="broadcastTarget">
                                    <option value="all">All Users</option>
                                    <option value="active">Active Users Only</option>
                                    <option value="banned">Banned Users Only</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Broadcast Message</label>
                                <textarea class="form-textarea" id="broadcastContent" placeholder="Enter broadcast message..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <span class="material-icons">campaign</span>
                                Send Broadcast
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Message Templates</h3>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="useTemplate('welcome')">Welcome Message</button>
                        <button class="btn btn-secondary" onclick="useTemplate('withdrawal_approved')">Withdrawal Approved</button>
                        <button class="btn btn-secondary" onclick="useTemplate('withdrawal_rejected')">Withdrawal Rejected</button>
                        <button class="btn btn-secondary" onclick="useTemplate('account_warning')">Account Warning</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Task</h3>
                <button class="close-btn" onclick="closeModal('addTaskModal')">&times;</button>
            </div>
            <form id="addTaskForm">
                <div class="form-group">
                    <label class="form-label">Task Category</label>
                    <select class="form-select" id="newTaskCategory" required>
                        <option value="normal">Normal Task</option>
                        <option value="telegram">Telegram Task</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="newTaskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="newTaskDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Task URL</label>
                    <input type="url" class="form-input" id="newTaskUrl" required>
                </div>
                <div class="form-group" id="telegramChannelGroup" style="display: none;">
                    <label class="form-label">Telegram Channel (without @)</label>
                    <input type="text" class="form-input" id="newTaskTelegramChannel" placeholder="channelname">
                </div>
                <div class="form-group">
                    <label class="form-label">Reward (Points)</label>
                    <input type="number" class="form-input" id="newTaskReward" value="100" min="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Total Impressions</label>
                    <input type="number" class="form-input" id="newTaskImpressions" value="1000" min="100" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons">add</span>
                    Create Task
                </button>
            </form>
        </div>
    </div>

    <!-- Add Lucky Code Modal -->
    <div id="addLuckyCodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Lucky Code</h3>
                <button class="close-btn" onclick="closeModal('addLuckyCodeModal')">&times;</button>
            </div>
            <form id="addLuckyCodeForm">
                <div class="form-group">
                    <label class="form-label">Code</label>
                    <input type="text" class="form-input" id="newLuckyCode" placeholder="Enter code (e.g., LUCKY2024)" required>
                    <button type="button" class="btn btn-secondary" style="margin-top: 5px;" onclick="generateRandomCode()">
                        <span class="material-icons">casino</span>
                        Generate Random
                    </button>
                </div>
                <div class="form-group">
                    <label class="form-label">Reward (Points)</label>
                    <input type="number" class="form-input" id="newLuckyCodeReward" value="500" min="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Expires In (Hours)</label>
                    <input type="number" class="form-input" id="newLuckyCodeExpiry" value="24" min="1" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons">redeem</span>
                    Create Code
                </button>
            </form>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Task</h3>
                <button class="close-btn" onclick="closeModal('editTaskModal')">&times;</button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId">
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="editTaskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="editTaskDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Task URL</label>
                    <input type="url" class="form-input" id="editTaskUrl" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Reward (Points)</label>
                    <input type="number" class="form-input" id="editTaskReward" min="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editTaskStatus" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons">save</span>
                    Update Task
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration (same as main app)
        const firebaseConfig = {
            apiKey: "AIzaSyA3SqCHzN3kLj7DC8Cyu9OzxPFtIlyyii4",
            authDomain: "maneybux-clone.firebaseapp.com",
            projectId: "maneybux-clone",
            storageBucket: "maneybux-clone.firebasestorage.app",
            messagingSenderId: "153207109623",
            appId: "1:153207109623:web:4cd48633c49c2ba3c1a0f2c1a0f2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = '7829924006:AAFIOCnga8v6yOw08dCzvKDC8wS7Fuad_II';
        const TELEGRAM_API_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}`;

        // Global variables
        let allUsers = {};
        let allTasks = {};
        let allWithdrawals = {};
        let allLuckyCodes = {};

        // Message templates
        const messageTemplates = {
            welcome: "üéâ Welcome to EarnFlux! Start earning by completing tasks and watching ads. Good luck! üöÄ",
            withdrawal_approved: "‚úÖ Great news! Your withdrawal request has been approved and processed successfully. The TON has been sent to your wallet. Thank you for using EarnFlux! üí∞",
            withdrawal_rejected: "‚ùå We're sorry, but your withdrawal request has been rejected due to verification issues. Please contact support for more information. üìû",
            account_warning: "‚ö†Ô∏è This is a warning regarding your EarnFlux account. Please ensure you follow all platform rules to avoid any restrictions. Contact support if you have any questions. ü§ù"
        };

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            checkBotStatus();
            
            // Set up task category change listener
            document.getElementById('newTaskCategory').addEventListener('change', function() {
                const telegramGroup = document.getElementById('telegramChannelGroup');
                if (this.value === 'telegram') {
                    telegramGroup.style.display = 'block';
                    document.getElementById('newTaskTelegramChannel').required = true;
                } else {
                    telegramGroup.style.display = 'none';
                    document.getElementById('newTaskTelegramChannel').required = false;
                }
            });

            // Set up form submissions
            setupFormHandlers();
            
            // Set last updated time
            updateLastUpdatedTime();
            setInterval(updateLastUpdatedTime, 60000); // Update every minute
        });

        // Setup form handlers
        function setupFormHandlers() {
            // Add Task Form
            document.getElementById('addTaskForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleAddTask();
            });

            // Add Lucky Code Form
            document.getElementById('addLuckyCodeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleAddLuckyCode();
            });

            // Edit Task Form
            document.getElementById('editTaskForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleEditTask();
            });

            // Single Message Form
            document.getElementById('singleMessageForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleSendMessage();
            });

            // Broadcast Message Form
            document.getElementById('broadcastMessageForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleBroadcastMessage();
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                showAlert('Loading dashboard data...', 'info');
                
                await Promise.all([
                    loadUsers(),
                    loadTasks(),
                    loadWithdrawals(),
                    loadLuckyCodes()
                ]);

                updateDashboardStats();
                loadRecentActivities();
                analyzeIpAddresses();
                
                showAlert('Dashboard data loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('Error loading dashboard data', 'danger');
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const totalUsers = Object.keys(allUsers).length;
            const activeTasks = Object.values(allTasks).filter(task => task.status === 'active').length;
            const pendingWithdrawals = Object.values(allWithdrawals).filter(w => w.status === 'pending').length;
            const totalEarnings = Object.values(allUsers).reduce((sum, user) => sum + (user.totalEarned || 0), 0);

            document.getElementById('totalUsers').textContent = formatNumber(totalUsers);
            document.getElementById('totalTasks').textContent = formatNumber(activeTasks);
            document.getElementById('totalWithdrawals').textContent = formatNumber(pendingWithdrawals);
            document.getElementById('totalEarnings').textContent = formatNumber(totalEarnings);
        }

        // Load users from Firebase
        async function loadUsers() {
            try {
                const snapshot = await database.ref('users').once('value');
                allUsers = snapshot.val() || {};
                displayUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Error loading users', 'danger');
            }
        }

        // Display users in table
        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (Object.keys(allUsers).length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No users found</td></tr>';
                return;
            }

            Object.entries(allUsers).forEach(([userId, user]) => {
                const row = document.createElement('tr');
                if (user.status === 'banned') {
                    row.classList.add('ip-duplicate');
                }

                const joinDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'Unknown';
                
                row.innerHTML = `
                    <td>${userId}</td>
                    <td>${user.first_name || 'Unknown'}</td>
                    <td>@${user.username || 'N/A'}</td>
                    <td>${formatNumber(user.balance || 0)}</td>
                    <td>${(user.tonBalance || 0).toFixed(8)}</td>
                    <td>${user.ipAddress || 'N/A'}</td>
                    <td>${joinDate}</td>
                    <td><span class="status-badge status-${user.status || 'active'}">${user.status || 'active'}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${user.status === 'banned' ? 
                                `<button class="btn btn-success" onclick="unbanUser('${userId}')">
                                    <span class="material-icons">person_add</span>
                                    Unban
                                </button>` :
                                `<button class="btn btn-danger" onclick="banUser('${userId}')">
                                    <span class="material-icons">person_remove</span>
                                    Ban
                                </button>`
                            }
                            <button class="btn btn-primary" onclick="sendMessageToUser('${userId}')">
                                <span class="material-icons">message</span>
                                Message
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter users
        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const statusFilter = document.getElementById('userStatusFilter').value;

            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1) {
                    const userId = cells[0].textContent.toLowerCase();
                    const name = cells[1].textContent.toLowerCase();
                    const username = cells[2].textContent.toLowerCase();
                    const status = cells[7].textContent.trim().toLowerCase();

                    const matchesSearch = userId.includes(searchTerm) || 
                                        name.includes(searchTerm) || 
                                        username.includes(searchTerm);
                    const matchesStatus = !statusFilter || status === statusFilter;

                    row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
                }
            });
        }

        // Ban user
        async function banUser(userId) {
            if (!confirm(`Are you sure you want to ban user ${userId}?`)) return;

            try {
                await database.ref(`users/${userId}/status`).set('banned');
                await sendTelegramMessage(userId, "‚ö†Ô∏è Your EarnFlux account has been suspended. Please contact support for more information.");
                showAlert(`User ${userId} has been banned successfully`, 'success');
                loadUsers();
            } catch (error) {
                console.error('Error banning user:', error);
                showAlert('Error banning user', 'danger');
            }
        }

        // Unban user
        async function unbanUser(userId) {
            if (!confirm(`Are you sure you want to unban user ${userId}?`)) return;

            try {
                await database.ref(`users/${userId}/status`).set('active');
                await sendTelegramMessage(userId, "üéâ Good news! Your EarnFlux account has been restored. Welcome back and happy earning!");
                showAlert(`User ${userId} has been unbanned successfully`, 'success');
                loadUsers();
            } catch (error) {
                console.error('Error unbanning user:', error);
                showAlert('Error unbanning user', 'danger');
            }
        }

        // Load tasks
        async function loadTasks() {
            try {
                const snapshot = await database.ref('tasks').once('value');
                allTasks = snapshot.val() || {};
                displayTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                showAlert('Error loading tasks', 'danger');
            }
        }

        // Display tasks
        function displayTasks() {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = '';

            if (Object.keys(allTasks).length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No tasks found</td></tr>';
                return;
            }

            Object.entries(allTasks).forEach(([taskId, task]) => {
                const row = document.createElement('tr');
                
                const createdBy = task.createdBy ? `User ${task.createdBy}` : 'Admin';
                const remainingImpressions = task.remainingImpressions || task.impressions || 0;
                const totalImpressions = task.impressions || 0;
                
                row.innerHTML = `
                    <td>${taskId.substring(0, 8)}...</td>
                    <td>${task.title || 'Untitled'}</td>
                    <td><span class="status-badge status-${task.category || 'normal'}">${task.category || 'normal'}</span></td>
                    <td>${task.reward || 0} points</td>
                    <td>${remainingImpressions}/${totalImpressions}</td>
                    <td>${createdBy}</td>
                    <td><span class="status-badge status-${task.status || 'active'}">${task.status || 'active'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="editTask('${taskId}')">
                                <span class="material-icons">edit</span>
                                Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteTask('${taskId}')">
                                <span class="material-icons">delete</span>
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter tasks
        function filterTasks() {
            const searchTerm = document.getElementById('taskSearch').value.toLowerCase();
            const statusFilter = document.getElementById('taskStatusFilter').value;

            const rows = document.querySelectorAll('#tasksTableBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1) {
                    const title = cells[1].textContent.toLowerCase();
                    const status = cells[6].textContent.trim().toLowerCase();

                    const matchesSearch = title.includes(searchTerm);
                    const matchesStatus = !statusFilter || status === statusFilter;

                    row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
                }
            });
        }

        // Add new task
        async function handleAddTask() {
            try {
                const taskData = {
                    title: document.getElementById('newTaskTitle').value.trim(),
                    description: document.getElementById('newTaskDescription').value.trim(),
                    url: document.getElementById('newTaskUrl').value.trim(),
                    category: document.getElementById('newTaskCategory').value,
                    reward: parseInt(document.getElementById('newTaskReward').value),
                    impressions: parseInt(document.getElementById('newTaskImpressions').value),
                    remainingImpressions: parseInt(document.getElementById('newTaskImpressions').value),
                    createdBy: 'admin',
                    createdAt: Date.now(),
                    status: 'active'
                };

                if (taskData.category === 'telegram') {
                    taskData.telegramChannel = document.getElementById('newTaskTelegramChannel').value.trim();
                }

                await database.ref('tasks').push(taskData);
                
                document.getElementById('addTaskForm').reset();
                closeModal('addTaskModal');
                showAlert('Task created successfully!', 'success');
                loadTasks();
            } catch (error) {
                console.error('Error adding task:', error);
                showAlert('Error creating task', 'danger');
            }
        }

        // Edit task
        function editTask(taskId) {
            const task = allTasks[taskId];
            if (!task) return;

            document.getElementById('editTaskId').value = taskId;
            document.getElementById('editTaskTitle').value = task.title || '';
            document.getElementById('editTaskDescription').value = task.description || '';
            document.getElementById('editTaskUrl').value = task.url || '';
            document.getElementById('editTaskReward').value = task.reward || 0;
            document.getElementById('editTaskStatus').value = task.status || 'active';

            showModal('editTaskModal');
        }

        // Handle edit task
        async function handleEditTask() {
            try {
                const taskId = document.getElementById('editTaskId').value;
                const updates = {
                    title: document.getElementById('editTaskTitle').value.trim(),
                    description: document.getElementById('editTaskDescription').value.trim(),
                    url: document.getElementById('editTaskUrl').value.trim(),
                    reward: parseInt(document.getElementById('editTaskReward').value),
                    status: document.getElementById('editTaskStatus').value
                };

                await database.ref(`tasks/${taskId}`).update(updates);
                
                closeModal('editTaskModal');
                showAlert('Task updated successfully!', 'success');
                loadTasks();
            } catch (error) {
                console.error('Error updating task:', error);
                showAlert('Error updating task', 'danger');
            }
        }

        // Delete task
        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            try {
                await database.ref(`tasks/${taskId}`).remove();
                showAlert('Task deleted successfully!', 'success');
                loadTasks();
            } catch (error) {
                console.error('Error deleting task:', error);
                showAlert('Error deleting task', 'danger');
            }
        }

        // Load withdrawals
        async function loadWithdrawals() {
            try {
                const snapshot = await database.ref('withdrawals').once('value');
                allWithdrawals = snapshot.val() || {};
                displayWithdrawals();
            } catch (error) {
                console.error('Error loading withdrawals:', error);
                showAlert('Error loading withdrawals', 'danger');
            }
        }

        // Display withdrawals
        function displayWithdrawals() {
            const tbody = document.getElementById('withdrawalsTableBody');
            tbody.innerHTML = '';

            if (Object.keys(allWithdrawals).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No withdrawals found</td></tr>';
                return;
            }

            Object.entries(allWithdrawals).forEach(([withdrawalId, withdrawal]) => {
                const row = document.createElement('tr');
                
                const requestDate = new Date(withdrawal.createdAt).toLocaleDateString();
                const shortAddress = `${withdrawal.tonAddress.substring(0, 8)}...${withdrawal.tonAddress.substring(withdrawal.tonAddress.length - 8)}`;
                
                row.innerHTML = `
                    <td>${withdrawalId.substring(0, 8)}...</td>
                    <td>
                        ${withdrawal.username || 'Unknown'}<br>
                        <small>ID: ${withdrawal.userId}</small>
                    </td>
                    <td>${withdrawal.amountTon.toFixed(8)}</td>
                    <td title="${withdrawal.tonAddress}">${shortAddress}</td>
                    <td>${requestDate}</td>
                    <td><span class="status-badge status-${withdrawal.status}">${withdrawal.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${withdrawal.status === 'pending' ? `
                                <button class="btn btn-success" onclick="approveWithdrawal('${withdrawalId}')">
                                    <span class="material-icons">check_circle</span>
                                    Approve
                                </button>
                                <button class="btn btn-danger" onclick="rejectWithdrawal('${withdrawalId}')">
                                    <span class="material-icons">cancel</span>
                                    Reject
                                </button>
                            ` : `
                                <span style="color: var(--text-muted);">No actions available</span>
                            `}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter withdrawals
        function filterWithdrawals() {
            const searchTerm = document.getElementById('withdrawalSearch').value.toLowerCase();
            const statusFilter = document.getElementById('withdrawalStatusFilter').value;

            const rows = document.querySelectorAll('#withdrawalsTableBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1) {
                    const user = cells[1].textContent.toLowerCase();
                    const status = cells[5].textContent.trim().toLowerCase();

                    const matchesSearch = user.includes(searchTerm);
                    const matchesStatus = !statusFilter || status === statusFilter;

                    row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
                }
            });
        }

        // Approve withdrawal
        async function approveWithdrawal(withdrawalId) {
            if (!confirm('Are you sure you want to approve this withdrawal?')) return;

            try {
                const withdrawal = allWithdrawals[withdrawalId];
                
                await database.ref(`withdrawals/${withdrawalId}/status`).set('completed');
                
                // Send notification to user
                await sendTelegramMessage(
                    withdrawal.userId, 
                    `‚úÖ Great news! Your withdrawal of ${withdrawal.amountTon.toFixed(8)} TON has been approved and processed successfully! üéâüí∞`
                );
                
                showAlert('Withdrawal approved and user notified!', 'success');
                loadWithdrawals();
            } catch (error) {
                console.error('Error approving withdrawal:', error);
                showAlert('Error approving withdrawal', 'danger');
            }
        }

        // Reject withdrawal
        async function rejectWithdrawal(withdrawalId) {
            const reason = prompt('Enter rejection reason (optional):') || 'Verification failed';
            if (!confirm('Are you sure you want to reject this withdrawal?')) return;

            try {
                const withdrawal = allWithdrawals[withdrawalId];
                
                await database.ref(`withdrawals/${withdrawalId}`).update({
                    status: 'rejected',
                    rejectionReason: reason
                });
                
                // Refund the TON balance to user
                const userRef = database.ref(`users/${withdrawal.userId}`);
                await userRef.transaction((userData) => {
                    if (userData) {
                        userData.tonBalance = (userData.tonBalance || 0) + withdrawal.amountTon;
                    }
                    return userData;
                });
                
                // Send notification to user
                await sendTelegramMessage(
                    withdrawal.userId,
                    `‚ùå Your withdrawal request has been rejected. Reason: ${reason}. The TON has been refunded to your account. Please contact support if you have any questions. üìû`
                );
                
                showAlert('Withdrawal rejected, user notified, and amount refunded!', 'success');
                loadWithdrawals();
            } catch (error) {
                console.error('Error rejecting withdrawal:', error);
                showAlert('Error rejecting withdrawal', 'danger');
            }
        }

        // Load lucky codes
        async function loadLuckyCodes() {
            try {
                const snapshot = await database.ref('luckyCodes').once('value');
                allLuckyCodes = snapshot.val() || {};
                displayLuckyCodes();
            } catch (error) {
                console.error('Error loading lucky codes:', error);
                showAlert('Error loading lucky codes', 'danger');
            }
        }

        // Display lucky codes
        function displayLuckyCodes() {
            const tbody = document.getElementById('luckyCodesTableBody');
            tbody.innerHTML = '';

            if (Object.keys(allLuckyCodes).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No lucky codes found</td></tr>';
                return;
            }

            Object.entries(allLuckyCodes).forEach(([codeId, code]) => {
                const row = document.createElement('tr');
                
                const createdDate = new Date(code.createdAt || Date.now()).toLocaleDateString();
                const expiryDate = new Date(code.expiresAt).toLocaleDateString();
                const isExpired = code.expiresAt < Date.now();
                
                row.innerHTML = `
                    <td><strong>${code.code}</strong></td>
                    <td>${code.reward} points</td>
                    <td>${createdDate}</td>
                    <td style="color: ${isExpired ? 'var(--danger)' : 'var(--success)'}">
                        ${expiryDate} ${isExpired ? '(Expired)' : ''}
                    </td>
                    <td><span class="status-badge ${code.used ? 'status-completed' : 'status-active'}">
                        ${code.used ? 'Yes' : 'No'}
                    </span></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteLuckyCode('${codeId}')">
                            <span class="material-icons">delete</span>
                            Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Add lucky code
        async function handleAddLuckyCode() {
            try {
                const code = document.getElementById('newLuckyCode').value.trim().toUpperCase();
                const reward = parseInt(document.getElementById('newLuckyCodeReward').value);
                const expiryHours = parseInt(document.getElementById('newLuckyCodeExpiry').value);
                
                // Check if code already exists
                const existingCode = Object.values(allLuckyCodes).find(c => c.code === code);
                if (existingCode) {
                    showAlert('A lucky code with this name already exists!', 'danger');
                    return;
                }

                const codeData = {
                    code: code,
                    reward: reward,
                    createdAt: Date.now(),
                    expiresAt: Date.now() + (expiryHours * 60 * 60 * 1000),
                    used: false
                };

                await database.ref('luckyCodes').push(codeData);
                
                document.getElementById('addLuckyCodeForm').reset();
                closeModal('addLuckyCodeModal');
                showAlert('Lucky code created successfully!', 'success');
                loadLuckyCodes();
            } catch (error) {
                console.error('Error adding lucky code:', error);
                showAlert('Error creating lucky code', 'danger');
            }
        }

        // Generate random code
        function generateRandomCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'LUCKY';
            for (let i = 0; i < 4; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            document.getElementById('newLuckyCode').value = result;
        }

        // Delete lucky code
        async function deleteLuckyCode(codeId) {
            if (!confirm('Are you sure you want to delete this lucky code?')) return;

            try {
                await database.ref(`luckyCodes/${codeId}`).remove();
                showAlert('Lucky code deleted successfully!', 'success');
                loadLuckyCodes();
            } catch (error) {
                console.error('Error deleting lucky code:', error);
                showAlert('Error deleting lucky code', 'danger');
            }
        }

        // Send message to specific user
        async function handleSendMessage() {
            try {
                const userId = document.getElementById('messageUserId').value.trim();
                const message = document.getElementById('messageContent').value.trim();

                if (!userId || !message) {
                    showAlert('Please enter both User ID and message', 'warning');
                    return;
                }

                await sendTelegramMessage(userId, message);
                
                document.getElementById('singleMessageForm').reset();
                showAlert('Message sent successfully!', 'success');
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Error sending message', 'danger');
            }
        }

        // Send broadcast message
        async function handleBroadcastMessage() {
            try {
                const target = document.getElementById('broadcastTarget').value;
                const message = document.getElementById('broadcastContent').value.trim();

                if (!message) {
                    showAlert('Please enter a message', 'warning');
                    return;
                }

                let targetUsers = [];
                
                if (target === 'all') {
                    targetUsers = Object.keys(allUsers);
                } else if (target === 'active') {
                    targetUsers = Object.keys(allUsers).filter(userId => 
                        (allUsers[userId].status || 'active') === 'active'
                    );
                } else if (target === 'banned') {
                    targetUsers = Object.keys(allUsers).filter(userId => 
                        allUsers[userId].status === 'banned'
                    );
                }

                if (targetUsers.length === 0) {
                    showAlert('No users found for the selected target', 'warning');
                    return;
                }

                if (!confirm(`Send message to ${targetUsers.length} users?`)) return;

                let sentCount = 0;
                for (const userId of targetUsers) {
                    try {
                        await sendTelegramMessage(userId, message);
                        sentCount++;
                        
                        // Add small delay to avoid hitting rate limits
                        await new Promise(resolve => setTimeout(resolve, 50));
                    } catch (error) {
                        console.error(`Error sending to user ${userId}:`, error);
                    }
                }
                
                document.getElementById('broadcastMessageForm').reset();
                showAlert(`Broadcast sent to ${sentCount}/${targetUsers.length} users!`, 'success');
            } catch (error) {
                console.error('Error sending broadcast:', error);
                showAlert('Error sending broadcast message', 'danger');
            }
        }

        // Send Telegram message
        async function sendTelegramMessage(userId, message) {
            try {
                const response = await fetch(`${TELEGRAM_API_URL}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: userId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });

                const result = await response.json();
                
                if (!result.ok) {
                    throw new Error(result.description || 'Failed to send message');
                }
                
                return result;
            } catch (error) {
                console.error(`Error sending Telegram message to ${userId}:`, error);
                throw error;
            }
        }

        // Use message template
        function useTemplate(templateName) {
            const template = messageTemplates[templateName];
            if (template) {
                document.getElementById('messageContent').value = template;
                document.getElementById('broadcastContent').value = template;
            }
        }

        // Send message to user (from user management)
        function sendMessageToUser(userId) {
            document.getElementById('messageUserId').value = userId;
            showTab('messaging');
        }

        // Check bot status
        async function checkBotStatus() {
            try {
                const response = await fetch(`${TELEGRAM_API_URL}/getMe`);
                const result = await response.json();
                
                const statusElement = document.getElementById('botStatus');
                if (result.ok) {
                    statusElement.innerHTML = '<span style="color: var(--success);">Connected</span>';
                } else {
                    statusElement.innerHTML = '<span style="color: var(--danger);">Error</span>';
                }
            } catch (error) {
                console.error('Error checking bot status:', error);
                document.getElementById('botStatus').innerHTML = '<span style="color: var(--danger);">Offline</span>';
            }
        }

        // Load recent activities
        function loadRecentActivities() {
            const container = document.getElementById('recentActivities');
            const activities = [];

            // Recent user registrations
            Object.values(allUsers)
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 3)
                .forEach(user => {
                    activities.push({
                        type: 'user_joined',
                        message: `${user.first_name} joined the platform`,
                        time: user.createdAt || Date.now()
                    });
                });

            // Recent withdrawals
            Object.values(allWithdrawals)
                .sort((a, b) => b.createdAt - a.createdAt)
                .slice(0, 3)
                .forEach(withdrawal => {
                    activities.push({
                        type: 'withdrawal',
                        message: `Withdrawal request: ${withdrawal.amountTon.toFixed(4)} TON`,
                        time: withdrawal.createdAt
                    });
                });

            // Recent tasks
            Object.values(allTasks)
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 2)
                .forEach(task => {
                    activities.push({
                        type: 'task_created',
                        message: `New task created: ${task.title}`,
                        time: task.createdAt || Date.now()
                    });
                });

            activities.sort((a, b) => b.time - a.time);

            if (activities.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">No recent activities</p>';
                return;
            }

            container.innerHTML = activities.slice(0, 5).map(activity => `
                <div style="margin-bottom: 10px; padding: 10px; background: var(--surface-dark-alt); border-radius: 8px;">
                    <div style="font-weight: 600; color: var(--text-primary);">${activity.message}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">${new Date(activity.time).toLocaleString()}</div>
                </div>
            `).join('');
        }

        // Analyze IP addresses
        function analyzeIpAddresses() {
            const container = document.getElementById('ipAnalysis');
            const ipGroups = {};

            // Group users by IP address
            Object.values(allUsers).forEach(user => {
                const ip = user.ipAddress || 'Unknown';
                if (!ipGroups[ip]) {
                    ipGroups[ip] = [];
                }
                ipGroups[ip].push(user);
            });

            // Find IPs with multiple users
            const duplicateIPs = Object.entries(ipGroups)
                .filter(([ip, users]) => users.length > 1 && ip !== 'Unknown')
                .sort(([, a], [, b]) => b.length - a.length);

            if (duplicateIPs.length === 0) {
                container.innerHTML = '<p style="color: var(--success);">‚úÖ No duplicate IP addresses detected</p>';
                return;
            }

            container.innerHTML = `
                <div style="color: var(--warning); margin-bottom: 15px;">
                    ‚ö†Ô∏è Found ${duplicateIPs.length} IP addresses with multiple users
                </div>
                ${duplicateIPs.map(([ip, users]) => `
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 10px;">
                        <strong>IP: ${ip}</strong> (${users.length} users)
                        <div style="margin-top: 10px;">
                            ${users.map(user => `
                                <div style="display: inline-block; margin: 5px 10px 0 0; padding: 5px 10px; background: var(--surface-dark); border-radius: 5px;">
                                    ${user.first_name} (${user.id}) 
                                    <span class="status-badge status-${user.status || 'active'}">${user.status || 'active'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Refresh all data
        async function refreshData() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('refresh-indicator');
            
            try {
                await loadDashboardData();
            } finally {
                refreshIcon.classList.remove('refresh-indicator');
            }
        }

        // Update last updated time
        function updateLastUpdatedTime() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Modal management
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                
                // Reset forms
                const forms = modal.querySelectorAll('form');
                forms.forEach(form => form.reset());
            }
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertContainer = document.querySelector('.container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span class="material-icons">${type === 'success' ? 'check_circle' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'error'}</span>
                ${message}
            `;
            
            alertContainer.insertBefore(alert, alertContainer.firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Format numbers
        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toString();
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>
