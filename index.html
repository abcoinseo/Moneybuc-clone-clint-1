<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnFlux - Professional Earning Platform</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        /* --- PASTE THE ENTIRE CSS HERE --- */
        /* (The complete CSS from your original code will be placed here) */

        /* New styles or modifications for the wallet connect button */
        .ton-connect-wrapper {
            margin-top: 15px; /* Add some space above the button */
            margin-bottom: 25px; /* Add space below the button */
            text-align: center; /* Center the button if it's inline-block */
        }

        .ton-connect-wrapper .btn-primary {
            /* You can add specific styles here if needed, but general btn-primary should work */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                <img src="https://via.placeholder.com/50" alt="User Avatar" class="user-avatar" id="userAvatar">
                <div class="user-details">
                    <h3 id="userName">Loading...</h3>
                    <div class="user-balance">
                        <span class="material-icons">account_balance_wallet</span>
                        <span id="userBalance">0</span> Points
                    </div>
                </div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span class="material-icons">dark_mode</span>
                Red Moon
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalEarned">0</div>
                <div class="stat-label">Total Earned</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tasksCompleted">0</div>
                <div class="stat-label">Tasks Done</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="referrals">0</div>
                <div class="stat-label">Referrals</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="spinsAvailable">0</div>
                <div class="stat-label">Spins Left</div>
            </div>
        </div>

        <!-- Home Section -->
        <div id="homeSection" class="section active">
            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">home</span>
                    Welcome Back!
                </h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showSection('tasks')">
                        <span class="material-icons">assignment</span>
                        Start Tasks
                    </button>
                    <button class="btn btn-warning" onclick="showSection('spin')">
                        <span class="material-icons">casino</span>
                        Spin Wheel
                    </button>
                    <button class="btn btn-success" onclick="dailyCheckin()">
                        <span class="material-icons">event_available</span>
                        Daily Check-in
                    </button>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">redeem</span>
                    Lucky Code
                </h2>
                <div class="form-group">
                    <input type="text" class="form-input" id="luckyCodeInput" placeholder="Enter lucky code">
                </div>
                <button class="btn btn-primary" onclick="applyLuckyCode()">
                    <span class="material-icons">card_giftcard</span>
                    Apply Code
                </button>
            </div>

            <!-- Wallet connection on Home page - keeping it as a fallback or general access -->
            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">link</span>
                    TON Wallet
                </h2>
                <!-- This is the TON Connect UI button. If you want it to be dynamic,
                     you'll rely on the tonConnectUI.onStatusChange in JS.
                     For simplicity here, we'll show the manual connect button if not connected. -->
                <div id="ton-connect"></div> <!-- This is where TON Connect UI injects its button -->
                <div class="ton-connect-wrapper">
                    <!-- This button will be managed by JS to show/hide or change text based on connection status -->
                    <button class="btn btn-primary" id="connectWalletButton" onclick="connectToWallet()">
                        <span class="material-icons">account_balance_wallet</span>
                        Connect Wallet
                    </button>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div id="tasksSection" class="section">
            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">assignment</span>
                    Tasks
                </h2>
                <div class="add-task-button">
                    <button class="btn btn-primary" onclick="showSection('addTask')">
                        <span class="material-icons">add</span>
                        Create New Task
                    </button>
                </div>
                <div class="tabs">
                    <div class="tab active" onclick="showTaskTab('available')">Available</div>
                    <div class="tab" onclick="showTaskTab('completed')">Completed</div>
                </div>

                <div id="availableTasks" class="tab-content active">
                    <div class="task-grid" id="availableTasksGrid">
                        <!-- Available tasks will be loaded here -->
                    </div>
                </div>

                <div id="completedTasks" class="tab-content">
                    <div class="task-grid" id="completedTasksGrid">
                        <!-- Completed tasks will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Task Section -->
        <div id="addTaskSection" class="section">
            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">add_task</span>
                    Create Task
                </h2>
                <!-- TON Wallet Connection Button MOVED HERE -->
                <h3 class="card-title" style="margin-top: 0; margin-bottom: 15px;">
                    <span class="material-icons">link</span>
                    TON Wallet Connection
                </h3>
                <!-- This is the TON Connect UI button. If you want it to be dynamic,
                     you'll rely on the tonConnectUI.onStatusChange in JS.
                     For simplicity here, we'll show the manual connect button if not connected. -->
                <div id="ton-connect-addTask"></div> <!-- Unique ID for addTask page -->
                <div class="ton-connect-wrapper">
                    <!-- This button will be managed by JS to show/hide or change text based on connection status -->
                    <button class="btn btn-primary" id="connectWalletButtonAddTask" onclick="connectToWallet('addTask')"> <!-- Add a parameter to distinguish -->
                        <span class="material-icons">account_balance_wallet</span>
                        Connect Wallet
                    </button>
                </div>
                <!-- END MOVED SECTION -->

                <form id="addTaskForm">
                    <div class="form-group">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-input" id="newTaskTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Task Description</label>
                        <textarea class="form-input" id="newTaskDescription" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Task URL</label>
                        <input type="url" class="form-input" id="newTaskUrl" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Impressions (100-5000)</label>
                        <input type="number" class="form-input" id="taskImpressions" min="100" max="5000" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Cost: <span id="totalCost">0</span> TON</label>
                        <div class="form-label" style="font-size: 12px; color: var(--text-light);">
                            Rate: 0.1 TON per 100 impressions
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">payment</span>
                        Create & Pay
                    </button>
                </form>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">list</span>
                    My Created Tasks
                </h2>
                <div id="myTasksGrid" class="task-grid">
                    <!-- User's created tasks will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Spin Section -->
        <div id="spinSection" class="section">
            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">casino</span>
                    Spin Wheel
                </h2>
                <div style="text-align: center;">
                    <div class="spin-wheel" id="spinWheel">
                        <div class="spin-center">SPIN</div>
                    </div>
                    <button class="btn btn-primary" id="spinButton" onclick="spinWheel()">
                        <span class="material-icons">casino</span>
                        Spin Now
                    </button>
                    <p style="margin-top: 15px; color: var(--text-light);">
                        Spins Available: <span id="spinsCount">0</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Ads Section -->
        <div id="adsSection" class="section">
            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">play_circle</span>
                    Watch Ads
                </h2>
                <div style="text-align: center;">
                    <p style="margin-bottom: 20px; color: var(--text-light);">
                        Daily Limit: <span id="adsWatched">0</span>/50
                    </p>
                    <button class="btn btn-primary" id="watchAdButton" onclick="watchAd()">
                        <span class="material-icons">play_arrow</span>
                        Watch Ad (+10 Points)
                    </button>
                    <div id="adCountdown" class="countdown" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Referral Section -->
        <div id="referralSection" class="section">
            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">people</span>
                    Referral System
                </h2>
                <div class="form-group">
                    <label class="form-label">Your Referral Link</label>
                    <div class="refer-link" id="referralLink">
                        https://t.me/adflareprobot/app?startapp=ref_<span id="userRefId">loading</span>
                    </div>
                    <button class="btn btn-secondary" onclick="copyReferralLink()">
                        <span class="material-icons">content_copy</span>
                        Copy Link
                    </button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="referralEarnings">0</div>
                        <div class="stat-label">Referral Earnings</div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="claimReferralRewards()">
                    <span class="material-icons">redeem</span>
                    Claim Rewards
                </button>

                <div style="margin-top: 20px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Referral List</h3>
                    <div id="referralList">
                        <!-- Referral list will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="section">
            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">person</span>
                    Profile
                </h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="https://via.placeholder.com/100" alt="Profile" class="user-avatar" style="width: 100px; height: 100px;" id="profileAvatar">
                    <h3 style="margin: 15px 0; color: var(--text);" id="profileName">Loading...</h3>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn btn-primary" onclick="showWithdrawModal()">
                        <span class="material-icons">account_balance</span>
                        Withdraw
                    </button>
                    <button class="btn btn-secondary" onclick="window.open('https://t.me/PixelfrogCommunity', '_blank')">
                        <span class="material-icons">support</span>
                        Support
                    </button>
                    <button class="btn btn-secondary" onclick="window.open('https://t.me/Pixelfrogchat', '_blank')">
                        <span class="material-icons">code</span>
                        Developer
                    </button>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <span class="material-icons">history</span>
                    Withdrawal History
                </h2>
                <div class="withdrawal-history" id="withdrawalHistory">
                    <!-- Withdrawal history will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->

    <div class="bottom-nav">
        <div class="nav-container">
            <a href="#" class="nav-item active" onclick="showSection('home'); return false;">
                <span class="material-icons">home</span>
                <span>Home</span>
            </a>

            <a href="#" class="nav-item" onclick="showSection('ads'); return false;">
                <span class="material-icons">play_circle</span>
                <span>Ads</span>
            </a>

            <a href="#" class="nav-item" onclick="showSection('tasks'); return false;">
                <span class="material-icons">assignment</span>
                <span>Tasks</span>
            </a>

            <a href="#" class="nav-item" onclick="showSection('referral'); return false;">
                <span class="material-icons">people</span>
                <span>Referral</span>
            </a>

            <a href="#" class="nav-item" onclick="showSection('profile'); return false;">
                <span class="material-icons">person</span>
                <span>Profile</span>
            </a>
        </div>
    </div>

    <!-- Task Verification Modal -->

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Task Verification</h3>
                <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div id="taskModalContent">
                <div class="countdown" id="taskCountdown">5</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="taskProgress"></div>
                </div>
                <p style="text-align: center; color: var(--text-light);">
                    Please wait while we verify your task completion...
                </p>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->

    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Withdraw Points</h3>
                <button class="close-btn" onclick="closeModal('withdrawModal')">&times;</button>
            </div>
            <form id="withdrawForm">
                <div class="form-group">
                    <label class="form-label">TON Address</label>
                    <input type="text" class="form-input" id="tonAddress" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (Points)</label>
                    <input type="number" class="form-input" id="withdrawAmount" min="2000" required>
                    <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
                        Minimum: 2000 points | Rate: 100 points = 0.000078 TON
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">You will receive: <span id="tonReceive">0</span> TON</label>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons">send</span>
                    Request Withdrawal
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9809601' data-sdk='show_9809601'></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3SqCHzN3kLj7DC8Cyu9OzxPFtIlyyii4",
            authDomain: "maneybux-clone.firebaseapp.com",
            projectId: "maneybux-clone",
            storageBucket: "maneybux-clone.firebasestorage.app",
            messagingSenderId: "153207109623",
            appId: "1:153207109623:web:4cd48633c49c2ba3c1a0f2"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- TON CONNECT UI SETUP ---
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://raw.githubusercontent.com/ton-community/tutorials/main/03-client/test/public/tonconnect-manifest.json',
            // We will dynamically set the button root ID based on the page context
        });

        // Default return URL
        tonConnectUI.uiOptions = {
            actionsConfiguration: {
                twaReturnUrl: 'https://t.me/EarnFluxBot' // <<< IMPORTANT: Update this to your actual bot's launch URL
            }
        };

        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let userBalance = 0;
        let userSpins = 0;
        let adsWatchedToday = 0;
        let lastAdTime = 0;
        let dailyCheckinDone = false;
        let lastAdCompletionTime = 0;
        const REFERRAL_BONUS_POINTS = 500;
        const TON_CONNECT_MANIFEST_URL = 'https://raw.githubusercontent.com/ton-community/tutorials/main/03-client/test/public/tonconnect-manifest.json';
        const BOT_USERNAME = 'adflareprobot'; // <<< IMPORTANT: Set your bot's username here

        // --- REFERRAL PARAMETERS ---
        // When the Telegram Web App initializes, we check for `start_param`.
        // We will pass this to handleReferral.

        // --- INITIALIZATION FUNCTIONS ---

        // Initialize Telegram Web App and get user data
        function initTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();

                const user = tg.initDataUnsafe?.user;
                const startParam = tg.initDataUnsafe?.start_param;

                if (user) {
                    currentUser = {
                        id: user.id,
                        username: user.username || 'User',
                        first_name: user.first_name || 'User',
                        photo_url: user.photo_url || 'https://via.placeholder.com/100'
                    };
                    console.log("Telegram User Found:", currentUser);

                    // Handle referral link from start_param
                    if (startParam && (startParam.startsWith('ref_') || startParam.startsWith('r_'))) {
                        const referrerId = startParam.replace('ref_', '').replace('r_', '');
                        handleReferral(referrerId);
                    }
                } else {
                    // Fallback for testing or if user data is not available
                    const randomId = Math.floor(Math.random() * 1000000000);
                    currentUser = {
                        id: randomId,
                        username: `testuser_${randomId}`,
                        first_name: 'Test User',
                        photo_url: 'https://via.placeholder.com/100'
                    };
                    console.warn("Telegram Web App user data not found. Using a random ID for testing:", currentUser.id);
                }
                initializeUser(); // Proceed to initialize user data from Firebase
            } else {
                console.error("Telegram Web App is not available.");
                showAlert("Error: Telegram Web App not detected. Please open this in Telegram.", "danger");
            }
        }

        // Initialize user data from Firebase (or create new if not exists)
        async function initializeUser() {
            if (!currentUser) {
                console.error("Cannot initialize user: currentUser is not set.");
                return;
            }

            const userRef = database.ref('users/' + currentUser.id);
            const snapshot = await userRef.once('value');

            if (!snapshot.exists()) {
                // Create new user in Firebase
                const userData = {
                    id: currentUser.id,
                    username: currentUser.username,
                    first_name: currentUser.first_name,
                    photo_url: currentUser.photo_url,
                    balance: 0,
                    spins: 0,
                    totalEarned: 0,
                    tasksCompleted: 0,
                    referrals: 0,
                    referralEarnings: 0, // This will be calculated dynamically based on referral bonus
                    adsWatched: 0,
                    lastAdReset: Date.now(),
                    lastCheckin: null,
                    createdAt: Date.now()
                };
                await userRef.set(userData);
                console.log("New user created in Firebase:", currentUser.id);
            }

            // Set up real-time listener for user data changes
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    // Update global variables
                    userBalance = userData.balance || 0;
                    userSpins = userData.spins || 0;
                    adsWatchedToday = userData.adsWatched || 0;
                    lastAdTime = userData.lastAdReset || 0;
                    dailyCheckinDone = userData.lastCheckin === new Date().toDateString();

                    // Reset daily ads if 24 hours have passed
                    if (Date.now() - lastAdTime > 24 * 60 * 60 * 1000) {
                        adsWatchedToday = 0;
                        userRef.update({
                            adsWatched: 0,
                            lastAdReset: Date.now()
                        });
                    }

                    updateUI(userData); // Update the UI elements
                }
            });

            // Load other data after user is initialized and listening
            loadTasks();
            loadUserTasks();
            loadReferrals();
            loadWithdrawalHistory();

            // Initialize TON Connect UI for the specific buttons
            initializeTonConnectButtons();
        }

        // Function to initialize TON Connect buttons dynamically
        function initializeTonConnectButtons(context = 'general') {
            const manifestUrl = TON_CONNECT_MANIFEST_URL;
            const walletButtonId = context === 'addTask' ? 'connectWalletButtonAddTask' : 'connectWalletButton';
            const tonConnectRootId = context === 'addTask' ? 'ton-connect-addTask' : 'ton-connect';

            // Ensure the root element exists before initializing
            const tonConnectRoot = document.getElementById(tonConnectRootId);
            if (!tonConnectRoot) {
                console.warn(`TON Connect root element not found for context: ${context}`);
                return;
            }

            // Remove any existing TON Connect UI buttons to avoid duplicates if re-initializing
            while (tonConnectRoot.firstChild) {
                tonConnectRoot.removeChild(tonConnectRoot.firstChild);
            }

            // Create the TonConnectUI instance targeting this specific root ID
            const tcInstance = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: manifestUrl,
                buttonRootId: tonConnectRootId // Target this specific root
            });

            // Set the return URL
            tcInstance.uiOptions = {
                actionsConfiguration: {
                    twaReturnUrl: 'https://t.me/EarnFluxBot' // <<< IMPORTANT: Update this to your actual bot's launch URL
                }
            };

            // Get the actual button element that TON Connect UI creates
            // It usually creates a button within the specified root.
            // We'll use the manual button click to open the modal, but TON Connect UI will manage its state.

            // Add listener for status changes for this specific instance if needed
            // For now, we'll rely on a global status change listener for simplicity
            // or manage the manual button state.

            // Manage the state of the manual connect button
            const manualButton = document.getElementById(walletButtonId);
            if (manualButton) {
                // Check current connection status
                if (tcInstance.connectedWallet()) {
                    manualButton.textContent = 'Wallet Connected';
                    manualButton.disabled = true;
                    manualButton.style.background = 'linear-gradient(135deg, var(--success), #047857)'; // Green
                } else {
                    manualButton.textContent = 'Connect Wallet';
                    manualButton.disabled = false;
                    manualButton.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-dark))'; // Red
                }
            }
        }


        // --- UI UPDATE FUNCTIONS ---

        // Update UI elements with user data
        function updateUI(userData) {
            document.getElementById('userName').textContent = userData.first_name || 'User';
            document.getElementById('userBalance').textContent = formatNumber(userData.balance || 0);
            document.getElementById('totalEarned').textContent = formatNumber(userData.totalEarned || 0);
            document.getElementById('tasksCompleted').textContent = formatNumber(userData.tasksCompleted || 0);
            document.getElementById('referrals').textContent = formatNumber(userData.referrals || 0);
            document.getElementById('spinsAvailable').textContent = userData.spins || 0;
            document.getElementById('spinsCount').textContent = userData.spins || 0;
            document.getElementById('adsWatched').textContent = adsWatchedToday;
            document.getElementById('userRefId').textContent = userData.id;

            if (userData.photo_url) {
                document.getElementById('userAvatar').src = userData.photo_url;
                document.getElementById('profileAvatar').src = userData.photo_url;
            }

            document.getElementById('profileName').textContent = userData.first_name || 'User';

            // Update watch ad button state
            const watchAdButton = document.getElementById('watchAdButton');
            if (adsWatchedToday >= 50) {
                watchAdButton.disabled = true;
                watchAdButton.innerHTML = '<span class="material-icons">block</span> Daily Limit Reached';
            } else {
                watchAdButton.disabled = false;
                watchAdButton.innerHTML = '<span class="material-icons">play_arrow</span> Watch Ad (+10 Points)';
            }

            // Update daily check-in button state
            const dailyCheckinButton = document.querySelector('.btn-success[onclick="dailyCheckin()"]');
            if (dailyCheckinButton) { // Check if the button exists on the current view
                if (dailyCheckinDone) {
                    dailyCheckinButton.textContent = 'Checked In!';
                    dailyCheckinButton.disabled = true;
                    dailyCheckinButton.classList.remove('btn-success');
                    dailyCheckinButton.classList.add('btn-secondary');
                } else {
                    dailyCheckinButton.textContent = 'Daily Check-in';
                    dailyCheckinButton.disabled = false;
                    dailyCheckinButton.classList.remove('btn-secondary');
                    dailyCheckinButton.classList.add('btn-success');
                }
            }

            // Update TON connect button states based on global status
            updateGlobalTonConnectButtonState();
        }

        // Update TON connect button state globally
        function updateGlobalTonConnectButtonState() {
            const walletConnected = tonConnectUI.connectedWallet();

            // Update button on Home page
            const connectWalletButtonHome = document.getElementById('connectWalletButton');
            if (connectWalletButtonHome) {
                if (walletConnected) {
                    connectWalletButtonHome.textContent = 'Wallet Connected';
                    connectWalletButtonHome.disabled = true;
                    connectWalletButtonHome.style.background = 'linear-gradient(135deg, var(--success), #047857)'; // Green
                } else {
                    connectWalletButtonHome.textContent = 'Connect Wallet';
                    connectWalletButtonHome.disabled = false;
                    connectWalletButtonHome.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-dark))'; // Red
                }
            }

            // Update button on Add Task page
            const connectWalletButtonAddTask = document.getElementById('connectWalletButtonAddTask');
            if (connectWalletButtonAddTask) {
                if (walletConnected) {
                    connectWalletButtonAddTask.textContent = 'Wallet Connected';
                    connectWalletButtonAddTask.disabled = true;
                    connectWalletButtonAddTask.style.background = 'linear-gradient(135deg, var(--success), #047857)'; // Green
                } else {
                    connectWalletButtonAddTask.textContent = 'Connect Wallet';
                    connectWalletButtonAddTask.disabled = false;
                    connectWalletButtonAddTask.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-dark))'; // Red
                }
            }
        }

        // --- TASK FUNCTIONS ---

        // Load available and completed tasks
        function loadTasks() {
            const availableTasksGrid = document.getElementById('availableTasksGrid');
            const completedTasksGrid = document.getElementById('completedTasksGrid');

            // Fetch tasks from 'tasks' node
            database.ref('tasks').on('value', (snapshot) => {
                availableTasksGrid.innerHTML = '';
                completedTasksGrid.innerHTML = '';

                const tasks = snapshot.val();
                if (!tasks) {
                    availableTasksGrid.innerHTML = '<p style="text-align: center; color: var(--text-light);">No tasks available</p>';
                    return;
                }

                // Fetch user's task completions from 'userTasks' node
                database.ref('userTasks/' + currentUser.id).once('value', (userTasksSnapshot) => {
                    const userTasksData = userTasksSnapshot.val() || {};

                    Object.keys(tasks).forEach(taskId => {
                        const task = tasks[taskId];
                        // A task is completed by the user if it exists in userTasks and has 'completed: true'
                        const isCompleted = userTasksData[taskId] && userTasksData[taskId].completed === true;
                        const taskCard = createTaskCard(taskId, task, isCompleted);

                        if (isCompleted) {
                            completedTasksGrid.appendChild(taskCard);
                        } else {
                            // Only show available tasks if the user hasn't completed them
                            availableTasksGrid.appendChild(taskCard);
                        }
                    });

                    // Display messages if grids are empty
                    if (availableTasksGrid.children.length === 0) {
                        availableTasksGrid.innerHTML = '<p style="text-align: center; color: var(--text-light);">No available tasks</p>';
                    }
                    if (completedTasksGrid.children.length === 0) {
                        completedTasksGrid.innerHTML = '<p style="text-align: center; color: var(--text-light);">No completed tasks</p>';
                    }
                });
            });
        }

        // Create HTML for a single task card
        function createTaskCard(taskId, task, isCompleted) {
            const card = document.createElement('div');
            card.className = 'task-card';

            const statusClass = isCompleted ? 'btn-success' : 'btn-primary';
            const statusText = isCompleted ? 'Completed' : 'Start Task';
            const statusIcon = isCompleted ? 'check_circle' : 'play_arrow';

            card.innerHTML = `
                <div class="task-header">
                    <div class="task-title">${task.title}</div>
                    <div class="task-reward">${task.reward} points</div>
                </div>
                <div class="task-description">${task.description}</div>
                <div class="task-actions">
                    <button class="btn ${statusClass}" ${isCompleted ? 'disabled' : `onclick="startTask('${taskId}', '${task.url}', ${task.reward})"`}>
                        <span class="material-icons">${statusIcon}</span>
                        ${statusText}
                    </button>
                </div>
            `;
            return card;
        }

        // Initiate a task (open URL, start countdown)
        function startTask(taskId, url, reward) {
            window.open(url, '_blank'); // Open the task URL

            document.getElementById('taskModal').style.display = 'block'; // Show verification modal

            let countdown = 5; // 5-second countdown
            const countdownElement = document.getElementById('taskCountdown');
            const progressElement = document.getElementById('taskProgress');

            const timer = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                // Update progress bar width
                progressElement.style.width = `${((5 - countdown) / 5) * 100}%`;

                if (countdown <= 0) {
                    clearInterval(timer);
                    completeTask(taskId, reward); // Attempt to mark task as complete
                }
            }, 1000);
        }

        // Mark a task as completed and update user stats
        async function completeTask(taskId, reward) {
            try {
                const userRef = database.ref('users/' + currentUser.id);
                const userTaskRef = database.ref('userTasks/' + currentUser.id + '/' + taskId);

                const existingUserTaskSnapshot = await userTaskRef.once('value');
                // Prevent re-completing a task
                if (existingUserTaskSnapshot.exists() && existingUserTaskSnapshot.val().completed === true) {
                    closeModal('taskModal');
                    showAlert('This task has already been completed.', 'warning');
                    return;
                }

                // Update user's balance, total earned, tasks completed, and award a spin
                await userRef.transaction((userData) => {
                    if (userData) {
                        userData.balance = (userData.balance || 0) + reward;
                        userData.totalEarned = (userData.totalEarned || 0) + reward;
                        userData.tasksCompleted = (userData.tasksCompleted || 0) + 1;
                        userData.spins = (userData.spins || 0) + 1; // Reward with a spin
                    }
                    return userData;
                });

                // Mark the task as completed for this user in the database
                await userTaskRef.set({
                    completedAt: Date.now(),
                    reward: reward,
                    completed: true
                });

                closeModal('taskModal');
                showAlert(`Task completed! You earned ${reward} points and 1 spin!`, 'success');

            } catch (error) {
                console.error('Error completing task:', error);
                showAlert('Error completing task. Please try again.', 'danger');
                closeModal('taskModal');
            }
        }

        // Load tasks created by the current user
        function loadUserTasks() {
            if (!currentUser) return;

            const myTasksGrid = document.getElementById('myTasksGrid');

            // Fetch tasks where 'createdBy' matches the current user's ID
            database.ref('tasks').orderByChild('createdBy').equalTo(currentUser.id).on('value', (snapshot) => {
                myTasksGrid.innerHTML = ''; // Clear previous tasks
                const tasks = snapshot.val();

                if (!tasks) {
                    myTasksGrid.innerHTML = '<p style="text-align: center; color: var(--text-light);">No tasks created by you yet.</p>';
                    return;
                }

                Object.keys(tasks).forEach(taskId => {
                    const task = tasks[taskId];
                    const taskCard = createUserTaskCard(taskId, task);
                    myTasksGrid.appendChild(taskCard);
                });
            });
        }

        // Create HTML for a user's own created task card
        function createUserTaskCard(taskId, task) {
            const card = document.createElement('div');
            card.className = 'task-card';

            const progressWidth = task.impressions ? ((task.impressions - (task.remainingImpressions || task.impressions)) / task.impressions) * 100 : 0;
            const isTaskCompleted = task.remainingImpressions <= 0;

            card.innerHTML = `
                <div class="task-header">
                    <div class="task-title">${task.title}</div>
                    <div class="task-reward">${task.remainingImpressions || 0}/${task.impressions || 0}</div>
                </div>
                <div class="task-description">${task.description}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progressWidth}%"></div>
                </div>
                <div class="task-actions">
                    ${isTaskCompleted ?
                        `<button class="btn btn-danger" onclick="deleteUserTask('${taskId}')">
                            <span class="material-icons">delete</span>
                            Delete
                        </button>` :
                        `<span style="color: var(--text-light); font-size: 12px;">Active</span>`
                    }
                </div>
            `;
            return card;
        }

        // Delete a task created by the user
        async function deleteUserTask(taskId) {
            if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
                try {
                    await database.ref('tasks/' + taskId).remove();
                    showAlert('Task deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting task:', error);
                    showAlert('Error deleting task. Please try again.', 'danger');
                }
            }
        }

        // --- OTHER FEATURES FUNCTIONS ---

        // Apply a lucky code
        async function applyLuckyCode() {
            const codeInput = document.getElementById('luckyCodeInput');
            const code = codeInput.value.trim().toUpperCase();
            if (!code) {
                showAlert('Please enter a lucky code', 'danger');
                return;
            }

            try {
                const codesRef = database.ref('luckyCodes');
                const snapshot = await codesRef.once('value');
                const codes = snapshot.val();

                if (!codes) {
                    showAlert('No lucky codes available.', 'danger');
                    return;
                }

                let foundCode = null;
                let codeKey = null;

                Object.keys(codes).forEach(key => {
                    if (codes[key].code === code && !codes[key].used && codes[key].expiresAt > Date.now()) {
                        foundCode = codes[key];
                        codeKey = key;
                    }
                });

                if (!foundCode) {
                    showAlert('Invalid, expired, or already used lucky code', 'danger');
                    return;
                }

                // Update user balance and total earned
                const userRef = database.ref('users/' + currentUser.id);
                await userRef.transaction((userData) => {
                    if (userData) {
                        userData.balance = (userData.balance || 0) + foundCode.reward;
                        userData.totalEarned = (userData.totalEarned || 0) + foundCode.reward;
                    }
                    return userData;
                });

                // Mark code as used
                await database.ref('luckyCodes/' + codeKey).update({ used: true });

                codeInput.value = ''; // Clear input
                showAlert(`Lucky code applied! You earned ${foundCode.reward} points!`, 'success');

            } catch (error) {
                console.error('Error applying lucky code:', error);
                showAlert('Error applying lucky code. Please try again.', 'danger');
            }
        }

        // Spin the wheel to get a reward
        function spinWheel() {
            if (userSpins <= 0) {
                showAlert('No spins available! Complete tasks to earn spins.', 'danger');
                return;
            }

            const spinButton = document.getElementById('spinButton');
            const wheel = document.getElementById('spinWheel');

            spinButton.disabled = true;
            wheel.style.transition = 'transform 3s cubic-bezier(0.23, 1, 0.32, 1)'; // Ensure transition is applied
            const randomRotation = Math.floor(Math.random() * 360) + 1800; // Multiple full rotations + random
            wheel.style.transform = `rotate(${randomRotation}deg)`;

            setTimeout(async () => {
                const finalPosition = randomRotation % 360;
                let reward;

                if (finalPosition < 60) reward = 100;
                else if (finalPosition < 120) reward = 150;
                else if (finalPosition < 180) reward = 200;
                else if (finalPosition < 240) reward = 300;
                else if (finalPosition < 300) reward = 400;
                else reward = 500;

                const userRef = database.ref('users/' + currentUser.id);
                await userRef.transaction((userData) => {
                    if (userData) {
                        userData.balance = (userData.balance || 0) + reward;
                        userData.totalEarned = (userData.totalEarned || 0) + reward;
                        userData.spins = Math.max(0, (userData.spins || 0) - 1); // Decrement spin count
                    }
                    return userData;
                });

                spinButton.disabled = false;
                wheel.style.transform = ''; // Reset transform for next spin
                showAlert(`Congratulations! You won ${reward} points!`, 'success');

            }, 3000); // Match animation duration
        }

        // Watch an ad for points
        async function watchAd() {
            if (adsWatchedToday >= 50) {
                showAlert('Daily ad limit reached. Come back tomorrow!', 'danger');
                return;
            }

            if (Date.now() - lastAdCompletionTime < 30000) { // Prevent rapid watching (30s cooldown)
                showAlert('Please wait a moment before watching another ad.', 'warning');
                return;
            }

            try {
                // This calls the SDK function to show an ad
                await show_9809601();

                const userRef = database.ref('users/' + currentUser.id);
                await userRef.transaction((userData) => {
                    if (userData) {
                        userData.balance = (userData.balance || 0) + 10;
                        userData.totalEarned = (userData.totalEarned || 0) + 10;
                        userData.adsWatched = (userData.adsWatched || 0) + 1;
                    }
                    return userData;
                });

                adsWatchedToday++;
                lastAdCompletionTime = Date.now();
                showAlert('Ad watched! You earned 10 points!', 'success');

            } catch (error) {
                console.error('Error watching ad:', error);
                showAlert('Error loading ad. Please try again.', 'danger');
            }
        }

        // Daily check-in function
        async function dailyCheckin() {
            const today = new Date().toDateString();
            const userRef = database.ref('users/' + currentUser.id);
            const snapshot = await userRef.once('value');
            const userData = snapshot.val();

            if (userData.lastCheckin === today) {
                showAlert('You have already checked in today!', 'danger');
                return;
            }

            // Prompt user to open a specific Telegram channel to verify check-in
            window.open('https://t.me/PixelfrogCommunity', '_blank');

            // Award points after a short delay
            setTimeout(async () => {
                await userRef.update({
                    balance: (userData.balance || 0) + 50, // Example: 50 points for daily check-in
                    totalEarned: (userData.totalEarned || 0) + 50,
                    lastCheckin: today
                });
                showAlert('Daily check-in completed! You earned 50 points!', 'success');
                // Update button state immediately
                const dailyCheckinButton = document.querySelector('.btn-success[onclick="dailyCheckin()"]');
                if (dailyCheckinButton) {
                    dailyCheckinButton.textContent = 'Checked In!';
                    dailyCheckinButton.disabled = true;
                    dailyCheckinButton.classList.remove('btn-success');
                    dailyCheckinButton.classList.add('btn-secondary');
                }
            }, 3000); // 3-second delay to give user time to potentially interact
        }

        // Handle form submission for creating a new task
        document.getElementById('addTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('newTaskTitle').value;
            const description = document.getElementById('newTaskDescription').value;
            const url = document.getElementById('newTaskUrl').value;
            const impressions = parseInt(document.getElementById('taskImpressions').value);
            const cost = (impressions / 100) * 0.1; // 0.1 TON per 100 impressions

            if (isNaN(impressions) || impressions < 100 || impressions > 5000) {
                showAlert('Please enter a valid number of impressions between 100 and 5000.', 'danger');
                return;
            }
            if (!title || !description || !url) {
                showAlert('Please fill in all task details.', 'danger');
                return;
            }

            // Check wallet connection before proceeding with payment
            if (!tonConnectUI.connectedWallet()) {
                showAlert('Please connect your TON wallet to create and pay for the task.', 'danger');
                return;
            }

            try {
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 60, // 60 seconds validity
                    messages: [{
                        address: "UQDLsNfQBwWXD9aaNxNS3udGo-9o8ybrlKmmbI5gjjRfs17M", // <<< IMPORTANT: Replace with your actual TON payment address
                        amount: (cost * 1000000000).toString() // Convert TON to nanoTON
                    }]
                };

                const result = await tonConnectUI.sendTransaction(transaction);

                if (result) { // Transaction was successful
                    const taskData = {
                        title,
                        description,
                        url,
                        reward: 100, // Fixed reward for now, can be dynamic
                        impressions,
                        remainingImpressions: impressions,
                        createdBy: currentUser.id,
                        createdAt: Date.now(),
                        status: 'active'
                    };

                    await database.ref('tasks').push(taskData); // Use push for auto-generated ID

                    document.getElementById('addTaskForm').reset();
                    showAlert('Task created successfully!', 'success');
                    loadUserTasks(); // Refresh the list of created tasks
                } else {
                    showAlert('TON transaction failed. Task not created.', 'danger');
                }
            } catch (error) {
                console.error('Error creating task:', error);
                showAlert('Error creating task. Please check your wallet connection and try again.', 'danger');
            }
        });

        // Update total cost display in the add task form
        document.getElementById('taskImpressions').addEventListener('input', (e) => {
            const impressions = parseInt(e.target.value) || 0;
            const cost = (impressions / 100) * 0.1;
            document.getElementById('totalCost').textContent = cost.toFixed(3);
        });

        // Load referral list and earnings
        function loadReferrals() {
            if (!currentUser) return;

            const referralList = document.getElementById('referralList');
            let totalReferralEarnings = 0; // Sum of bonuses for referred users

            database.ref('referrals/' + currentUser.id).on('value', (snapshot) => {
                referralList.innerHTML = '';
                const referrals = snapshot.val();

                if (!referrals) {
                    referralList.innerHTML = '<p style="text-align: center; color: var(--text-light);">No referrals yet.</p>';
                    document.getElementById('totalReferrals').textContent = '0';
                    document.getElementById('referralEarnings').textContent = '0';
                    return;
                }

                const referralIds = Object.keys(referrals);
                document.getElementById('totalReferrals').textContent = formatNumber(referralIds.length);

                referralIds.forEach(referredUserId => {
                    const referral = referrals[referredUserId];
                    // Sum up the fixed bonus for each referred user
                    totalReferralEarnings += REFERRAL_BONUS_POINTS;

                    const referralItem = document.createElement('div');
                    referralItem.className = 'history-item';
                    referralItem.innerHTML = `
                        <div>
                            <strong>${referral.username || 'User'}</strong>
                            <div style="font-size: 12px; color: var(--text-light);">
                                Joined: ${new Date(referral.joinedAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="history-status status-completed">Referred</div>
                    `;
                    referralList.appendChild(referralItem);
                });
                document.getElementById('referralEarnings').textContent = formatNumber(totalReferralEarnings);
            });
        }

        // Placeholder for claiming referral rewards (currently automated)
        async function claimReferralRewards() {
            showAlert('Referral rewards are automatically credited when a new user joins via your link!', 'success');
        }

        // Copy referral link to clipboard
        function copyReferralLink() {
            const link = `https://t.me/${BOT_USERNAME}/app?startapp=ref_${currentUser.id}`;
            navigator.clipboard.writeText(link).then(() => {
                showAlert('Referral link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy referral link: ', err);
                showAlert('Failed to copy link. Please copy it manually.', 'danger');
            });
        }

        // Show withdrawal modal
        function showWithdrawModal() {
            if (userBalance < 2000) {
                showAlert('Minimum withdrawal amount is 2000 points!', 'danger');
                return;
            }
            document.getElementById('withdrawModal').style.display = 'block';
            // Pre-fill the TON address if it's stored from a previous withdrawal (optional, needs DB logic)
        }

        // Handle withdrawal form submission
        document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const tonAddress = document.getElementById('tonAddress').value.trim();
            const amount = parseInt(document.getElementById('withdrawAmount').value);

            // Basic validation
            if (!tonAddress || !tonAddress.startsWith('UQ')) { // Simple TON address check
                showAlert('Please enter a valid TON address.', 'danger');
                return;
            }
            if (amount < 2000) {
                showAlert('Minimum withdrawal amount is 2000 points!', 'danger');
                return;
            }
            if (amount > userBalance) {
                showAlert('Insufficient balance!', 'danger');
                return;
            }

            try {
                const withdrawalData = {
                    userId: currentUser.id,
                    username: currentUser.username,
                    tonAddress,
                    amount, // Amount in points
                    // Calculate TON amount based on the defined rate
                    tonAmount: (amount / 100) * 0.000078,
                    status: 'pending',
                    createdAt: Date.now()
                };

                await database.ref('withdrawals').push(withdrawalData); // Add to withdrawals table

                // Deduct points from user's balance
                const userRef = database.ref('users/' + currentUser.id);
                await userRef.transaction((userData) => {
                    if (userData) {
                        userData.balance = Math.max(0, (userData.balance || 0) - amount);
                    }
                    return userData;
                });

                closeModal('withdrawModal');
                document.getElementById('withdrawForm').reset();
                showAlert('Withdrawal request submitted successfully! It will be processed shortly.', 'success');
                loadWithdrawalHistory(); // Refresh history

            } catch (error) {
                console.error('Error submitting withdrawal:', error);
                showAlert('Error submitting withdrawal. Please try again.', 'danger');
            }
        });

        // Update TON receive amount dynamically in withdraw form
        document.getElementById('withdrawAmount').addEventListener('input', (e) => {
            const amount = parseInt(e.target.value) || 0;
            const tonAmount = (amount / 100) * 0.000078;
            document.getElementById('tonReceive').textContent = tonAmount.toFixed(8);
        });

        // Load withdrawal history
        function loadWithdrawalHistory() {
            if (!currentUser) return;

            const withdrawalHistory = document.getElementById('withdrawalHistory');

            database.ref('withdrawals')
                .orderByChild('userId').equalTo(currentUser.id)
                .limitToLast(10) // Show last 10 withdrawals
                .on('value', (snapshot) => {
                    withdrawalHistory.innerHTML = '';
                    const withdrawals = snapshot.val();

                    if (!withdrawals) {
                        withdrawalHistory.innerHTML = '<p style="text-align: center; color: var(--text-light);">No withdrawal history yet.</p>';
                        return;
                    }

                    // Display in reverse chronological order
                    Object.values(withdrawals).reverse().forEach(withdrawal => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';

                        const statusClass = `status-${withdrawal.status}`;
                        const statusText = withdrawal.status.charAt(0).toUpperCase() + withdrawal.status.slice(1);

                        historyItem.innerHTML = `
                            <div>
                                <strong>${withdrawal.amount} points</strong>
                                <div style="font-size: 12px; color: var(--text-light);">
                                    ${withdrawal.tonAmount.toFixed(8)} TON • ${new Date(withdrawal.createdAt).toLocaleDateString()}
                                </div>
                            </div>
                            <div class="history-status ${statusClass}">${statusText}</div>
                        `;
                        withdrawalHistory.appendChild(historyItem);
                    });
                });
        }

        // --- TON CONNECT FUNCTIONS ---

        // Open TON Connect modal
        async function connectToWallet(context = 'general') {
            try {
                // The TON Connect UI handles the actual button creation and modal opening.
                // We just need to ensure the UI is initialized with the correct root.
                await tonConnectUI.openModal();
            } catch (error) {
                console.error("Error connecting to wallet:", error);
                showAlert('Error connecting to wallet. Please ensure you have a TON wallet installed and try again.', 'danger');
            }
        }

        // --- NAVIGATION AND MODAL FUNCTIONS ---

        // Switch between main sections of the app
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none'; // Hide all sections
            });
            document.getElementById(sectionName + 'Section').style.display = 'block'; // Show the selected one

            // Update active state in bottom navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('onclick').includes(`showSection('${sectionName}')`)) {
                    item.classList.add('active');
                }
            });

            // Re-initialize TON Connect buttons if the section has them and they weren't active
            // This ensures the correct button logic is applied when a section becomes visible.
            if (sectionName === 'addTask') {
                initializeTonConnectButtons('addTask');
            } else if (sectionName === 'home') {
                initializeTonConnectButtons('home'); // Or 'general' if that's how you handle it
            }
            updateGlobalTonConnectButtonState(); // Ensure button states are correct on section change
        }

        // Switch between tabs within the Tasks section
        function showTaskTab(tabName) {
            event.target.parentElement.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tasks').classList.add('active');
        }

        // Close a modal by its ID
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }

        // Display temporary alerts to the user
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            const icon = type === 'success' ? 'check_circle' : type === 'warning' ? 'warning' : 'error';
            alertDiv.innerHTML = `<span class="material-icons">${icon}</span>${message}`;
            document.querySelector('.container').prepend(alertDiv); // Add alert to the top of the container

            setTimeout(() => alertDiv.remove(), 5000); // Remove after 5 seconds
        }

        // Format large numbers for readability
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            num = Number(num);
            if (num >= 1e12) return (num / 1e12).toFixed(1).replace(/\.0$/, '') + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(1).replace(/\.0$/, '') + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1).replace(/\.0$/, '') + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1).replace(/\.0$/, '') + 'K';
            return num.toString();
        }

        // Theme toggle (currently static)
        function toggleTheme() {
            showAlert('Red Moon theme is the current and only theme!', 'success');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initTelegramWebApp(); // Initialize Telegram Web App and user data
            showSection('home'); // Set initial section to Home

            // Set up the global TON Connect UI status listener
            tonConnectUI.onStatusChange(wallet => {
                console.log("TON Connect Status Change:", wallet);
                updateGlobalTonConnectButtonState(); // Update the state of all visible connect buttons
            });

            // Add listener for clicking outside modals to close them
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            // Set initial state of TON Connect buttons on load
            updateGlobalTonConnectButtonState();
        });
    </script>
</body>
</html>
